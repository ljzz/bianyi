#
# https://github.com/P3TERX/Actions-OpenWrt
#
# æ–‡ä»¶ï¼š.github/workflows/openwrt-bulder.yml
# æè¿°ï¼šä½¿ç”¨ GitHub Actions æ„å»º OpenWrt
#
# ç‰ˆæƒæ‰€æœ‰ (c) 2019-2024 P3TERX <https://p3terx.com>
#
# è¿™æ˜¯è‡ªç”±è½¯ä»¶ï¼Œéµå¾ª MIT è®¸å¯è¯ã€‚
# æ›´å¤šä¿¡æ¯è¯·å‚é˜… /LICENSE
#

# å·¥ä½œæµåç§°
name: Build 237 High Power ImmortalWrt

# è§¦å‘æ¡ä»¶ï¼šé€šè¿‡ repository_dispatch äº‹ä»¶æˆ–æ‰‹åŠ¨è§¦å‘
on:
  repository_dispatch:
  workflow_dispatch:

env:
  # åŸºç¡€é…ç½®
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: openwrt-24.10-6.6
  FEEDS_CONF: feeds.conf.default
  HIGH_POWER_CONFIG_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6/blob/2410/defconfig/nx60pro-ipailna-high-power.config
  # è®¾å¤‡é…ç½®
  DEVICE_PROFILE: mediatek_filogic
  DEVICE_NAME: nix30_snand
  
  # åŠŸèƒ½é…ç½®
  UPLOAD_FIRMWARE: true                                           # æ˜¯å¦ä¸Šä¼ å›ºä»¶
  UPLOAD_RELEASE: true                                            # æ˜¯å¦å‘å¸ƒRelease
  FIRMWARE_TAG: padavanonly-237-mt798x-6.6                        # å›ºä»¶ç‰ˆæœ¬æ ‡ç­¾
  TZ: Asia/Shanghai                                               # æ—¶åŒºè®¾ç½®
  
  # ç½‘ç»œé…ç½®
  LAN_IP: 192.168.6.1
  WIFI_SSID: locust
  WIFI_SSID_5G: locust-5G
  WIFI_PASSWORD: 36925888
  PPPOE_USERNAME: 15828860970
  PPPOE_PASSWORD: 147258

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: p3terx/openwrt-builder:latest
    
    steps:
    # 1. æ‹‰å–å½“å‰ä»“åº“ä»£ç ï¼ˆä¸»è¦æ˜¯è„šæœ¬å’Œé…ç½®æ–‡ä»¶ï¼‰
    - name: Checkout
      uses: actions/checkout@main

    # 2. åˆå§‹åŒ–æ„å»ºç¯å¢ƒï¼Œå®‰è£…å¿…è¦çš„ä¾èµ–åŒ…
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # æ¸…ç†ç³»ç»Ÿï¼Œç§»é™¤ä¸å¿…è¦çš„è½¯ä»¶å’Œç¼“å­˜
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…ç¼–è¯‘æ‰€éœ€çš„å¤§é‡å·¥å…·å’Œåº“ï¼ˆå¦‚ç¼–è¯‘å™¨ã€åº“æ–‡ä»¶ã€å¼€å‘å·¥å…·ç­‰ï¼‰
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
        # æ¸…ç†æ— ç”¨çš„åŒ…å’Œç¼“å­˜
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "$TZ"
        # åˆ›å»ºå·¥ä½œç›®å½•å¹¶è®¾ç½®æƒé™
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    # 3. å…‹éš† OpenWrt æºç ä»“åº“åˆ° /workdir ç›®å½•
    - name: Clone source code
      working-directory: /workdir
      run: |
        df -hT $PWD  # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        git clone -b $REPO_BRANCH --single-branch --filter=blob:none $REPO_URL openwrt
        # åˆ›å»ºè½¯é“¾æ¥åˆ° GitHub å·¥ä½œåŒºï¼Œæ–¹ä¾¿åç»­æ­¥éª¤è®¿é—®
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    # 4. åŠ è½½è‡ªå®šä¹‰è½¯ä»¶æºé…ç½®å¹¶è¿è¡Œç¬¬ä¸€ä¸ªè‡ªå®šä¹‰è„šæœ¬
    - name: Load custom feeds
      run: |
        # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰çš„ feeds é…ç½®æ–‡ä»¶ï¼Œåˆ™æ›¿æ¢é»˜è®¤çš„
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        # ç»™è‡ªå®šä¹‰è„šæœ¬1æ·»åŠ æ‰§è¡Œæƒé™å¹¶è¿è¡Œ
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

 # 5. æ›´æ–°è½¯ä»¶æºï¼ˆfeedsï¼‰
    - name: Update feeds
      run: cd openwrt && ./scripts/feeds update -a

# 6. å®‰è£…æ‰€æœ‰å¯ç”¨çš„è½¯ä»¶åŒ…
    - name: Install feeds
      run: cd openwrt && ./scripts/feeds install -a   

    - name: Download high power configuration
      run: |
        cd openwrt
        wget $HIGH_POWER_CONFIG_URL -O .config      

    # 7. åŠ è½½è‡ªå®šä¹‰é…ç½®ï¼ˆæ–‡ä»¶ç³»ç»Ÿå’Œç¼–è¯‘é…ç½®ï¼‰å¹¶è¿è¡Œç¬¬äºŒä¸ªè‡ªå®šä¹‰è„šæœ¬
    - name: Load custom configuration
      run: |
        # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰æ–‡ä»¶ç³»ç»Ÿç›®å½•ï¼Œåˆ™ç§»åˆ° openwrt ç›®å½•ä¸‹
        [ -e files ] && mv files openwrt/files
        # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œåˆ™è®¾ä¸º openwrt çš„ .config
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        # ç»™è‡ªå®šä¹‰è„šæœ¬2æ·»åŠ æ‰§è¡Œæƒé™å¹¶è¿è¡Œ
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH      

        
        # 1. å®‰è£… Argon ä¸»é¢˜
        ./scripts/feeds install luci-theme-argon
        
        # 2. å®‰è£… OpenClash
        ./scripts/feeds install luci-app-openclash
        
        # 3. å®‰è£… iStore (å¦‚æœéœ€è¦ï¼Œè¿™é‡Œå‡è®¾ iStore åœ¨ feeds ä¸­)
        ./scripts/feeds install luci-app-store || echo "iStore not found in feeds, will be handled later"
        
        # 4. ç§»é™¤ä¸éœ€è¦çš„åŒ…
        sed -i '/CONFIG_PACKAGE_luci-app-adblock/d' .config
        sed -i '/CONFIG_PACKAGE_luci-app-docker/d' .config
        sed -i '/CONFIG_PACKAGE_docker/d' .config
        sed -i '/CONFIG_PACKAGE_dockerd/d' .config
        
        # 5. ç¡®ä¿åŸºç¡€åŠŸèƒ½
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
        echo "CONFIG_PACKAGE_odhcp6c=y" >> .config
        echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> .config
        
        # 6. ç¦ç”¨ä¸éœ€è¦çš„åŠŸèƒ½ï¼Œä¿æŒçº¯å‡€
        echo "# CONFIG_PACKAGE_luci-app-adblock is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-docker is not set" >> .config
        echo "# CONFIG_PACKAGE_docker is not set" >> .config
        echo "# CONFIG_PACKAGE_dockerd is not set" >> .config

    - name: Generate custom files
      run: |
        cd openwrt
        
        # åˆ›å»ºè‡ªå®šä¹‰æ–‡ä»¶ç›®å½•ç»“æ„
        mkdir -p files/etc/config
        mkdir -p files/etc/uci-defaults
        mkdir -p files/etc/wireless
        
        # 1. ç½‘ç»œé…ç½®æ–‡ä»¶
        cat > files/etc/config/network << 'EOF'
config interface 'loopback'
        option device 'lo'
        option proto 'static'
        option ipaddr '127.0.0.1'
        option netmask '255.0.0.0'

config globals 'globals'
        option ula_prefix 'fd00:ab:cd::/48'

config device
        option name 'br-lan'
        option type 'bridge'
        list ports 'eth0'

config interface 'lan'
        option device 'br-lan'
        option proto 'static'
        option ipaddr '${{ env.LAN_IP }}'
        option netmask '255.255.255.0'
        option ip6assign '60'

config interface 'wan'
        option device 'eth1'
        option proto 'pppoe'
        option username '${{ env.PPPOE_USERNAME }}'
        option password '${{ env.PPPOE_PASSWORD }}'
        option ipv6 'auto'

config interface 'wan6'
        option device 'eth1'
        option proto 'dhcpv6'
EOF

        # 2. æ— çº¿é…ç½®æ–‡ä»¶
        cat > files/etc/config/wireless << 'EOF'
config wifi-device 'radio0'
        option type 'mac80211'
        option path 'platform/18000000.wbsys'
        option channel '36'
        option band '5g'
        option htmode 'HE80'
        option cell_density '0'

config wifi-iface 'default_radio0'
        option device 'radio0'
        option network 'lan'
        option mode 'ap'
        option ssid '${{ env.WIFI_SSID_5G }}'
        option encryption 'psk2'
        option key '${{ env.WIFI_PASSWORD }}'
        option disabled '0'

config wifi-device 'radio1'
        option type 'mac80211'
        option path 'platform/18000000.wbsys'
        option channel 'auto'
        option band '2g'
        option htmode 'HT20'
        option cell_density '0'

config wifi-iface 'default_radio1'
        option device 'radio1'
        option network 'lan'
        option mode 'ap'
        option ssid '${{ env.WIFI_SSID }}'
        option encryption 'psk2'
        option key '${{ env.WIFI_PASSWORD }}'
        option disabled '0'
EOF

        # 3. DHCP é…ç½®æ–‡ä»¶
        cat > files/etc/config/dhcp << 'EOF'
config dnsmasq
        option domainneeded '1'
        option boguspriv '1'
        option filterwin2k '0'
        option localise_queries '1'
        option rebind_protection '1'
        option rebind_localhost '1'
        option local '/lan/'
        option domain 'lan'
        option expandhosts '1'
        option nonegcache '0'
        option authoritative '1'
        option readethers '1'
        option leasefile '/tmp/dhcp.leases'
        option resolvfile '/tmp/resolv.conf.d/resolv.conf.auto'
        option localservice '1'
        option ednspacket_max '1232'

config dhcp 'lan'
        option interface 'lan'
        option start '100'
        option limit '150'
        option leasetime '12h'
        option dhcpv4 'server'
        option dhcpv6 'server'
        option ra 'server'
        option ra_management '1'
        option ra_default '1'

config dhcp 'wan'
        option interface 'wan'
        option ignore '1'

config odhcpd 'odhcpd'
        option maindhcp '0'
        option leasefile '/tmp/hosts/odhcpd'
        option leasetrigger '/usr/sbin/odhcpd-update'
        option loglevel '4'
EOF

        # 4. é˜²ç«å¢™é…ç½®æ–‡ä»¶
        cat > files/etc/config/firewall << 'EOF'
config defaults
        option syn_flood '1'
        option input 'ACCEPT'
        option output 'ACCEPT'
        option forward 'REJECT'

config zone
        option name 'lan'
        option input 'ACCEPT'
        option output 'ACCEPT'
        option forward 'ACCEPT'
        option network 'lan'

config zone
        option name 'wan'
        option input 'REJECT'
        option output 'ACCEPT'
        option forward 'REJECT'
        option masq '1'
        option mtu_fix '1'
        option network 'wan wan6'

config forwarding
        option src 'lan'
        option dest 'wan'

config rule
        option name 'Allow-DHCP-Renew'
        option src 'wan'
        option proto 'udp'
        option dest_port '68'
        option target 'ACCEPT'
        option family 'ipv4'

config rule
        option name 'Allow-Ping'
        option src 'wan'
        option proto 'icmp'
        option icmp_type 'echo-request'
        option family 'ipv4'
        option target 'ACCEPT'

config rule
        option name 'Allow-IGMP'
        option src 'wan'
        option proto 'igmp'
        option family 'ipv4'
        option target 'ACCEPT'

config rule
        option name 'Allow-DHCPv6'
        option src 'wan'
        option proto 'udp'
        option dest_port '546'
        option family 'ipv6'
        option target 'ACCEPT'

config rule
        option name 'Allow-MLD'
        option src 'wan'
        option proto 'icmp'
        option src_ip 'fe80::/10'
        list icmp_type '130/0'
        list icmp_type '131/0'
        list icmp_type '132/0'
        list icmp_type '143/0'
        option family 'ipv6'
        option target 'ACCEPT'

config rule
        option name 'Allow-ICMPv6-Input'
        option src 'wan'
        option proto 'icmp'
        list icmp_type 'echo-request'
        list icmp_type 'echo-reply'
        list icmp_type 'destination-unreachable'
        list icmp_type 'packet-too-big'
        list icmp_type 'time-exceeded'
        list icmp_type 'bad-header'
        list icmp_type 'unknown-header-type'
        list icmp_type 'router-solicitation'
        list icmp_type 'neighbour-solicitation'
        list icmp_type 'router-advertisement'
        list icmp_type 'neighbour-advertisement'
        option limit '1000/sec'
        option family 'ipv6'
        option target 'ACCEPT'

config rule
        option name 'Allow-ICMPv6-Forward'
        option src 'wan'
        option dest '*'
        option proto 'icmp'
        list icmp_type 'echo-request'
        list icmp_type 'echo-reply'
        list icmp_type 'destination-unreachable'
        list icmp_type 'packet-too-big'
        list icmp_type 'time-exceeded'
        list icmp_type 'bad-header'
        list icmp_type 'unknown-header-type'
        option limit '1000/sec'
        option family 'ipv6'
        option target 'ACCEPT'
EOF

        # 5. ç³»ç»Ÿé…ç½®æ–‡ä»¶
        cat > files/etc/config/system << 'EOF'
config system
        option hostname 'ImmortalWrt'
        option timezone 'CST-8'
        option ttylogin '0'
        option log_size '64'
        option urandom_seed '0'

config timeserver 'ntp'
        list server 'time1.cloud.tencent.com'
        list server 'time2.cloud.tencent.com'
        list server 'time3.cloud.tencent.com'
        list server 'pool.ntp.org'
        option enabled '1'
        option enable_server '0'
EOF

        # 6. é»˜è®¤è„šæœ¬ - è®¾ç½®é»˜è®¤ä¸»é¢˜ä¸º Argon
        cat > files/etc/uci-defaults/99-custom << 'EOF'
#!/bin/sh

# è®¾ç½® Argon ä¸ºé»˜è®¤ä¸»é¢˜
uci set luci.main.mediaurlbase='/luci-static/argon'
uci commit luci

# è®¾ç½®æ—¶åŒº
uci set system.@system[0].timezone='CST-8'
uci set system.@system[0].zonename='Asia/Shanghai'
uci commit system

# å¯ç”¨ IPv6
uci set network.wan6=interface
uci set network.wan6.proto='dhcpv6'
uci set network.wan6.device='eth1'
uci set network.wan6.reqaddress='try'
uci set network.wan6.reqprefix='auto'
uci commit network

echo "Custom configuration applied successfully"
exit 0
EOF

        chmod +x files/etc/uci-defaults/99-custom

    - name: Finalize configuration
      run: |
        cd openwrt
        
        # æ›´æ–°é…ç½®
        make defconfig
        
        # æ£€æŸ¥é…ç½®
        echo "Current configuration summary:"
        grep -E "CONFIG_PACKAGE_luci|CONFIG_PACKAGE_ipv6" .config || true
        
        # ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…
        make download -j$(nproc) || make download -j1 || make download -j1 V=s

 # 8. ä¸‹è½½ç¼–è¯‘æ‰€éœ€çš„è½¯ä»¶åŒ…
    - name: Download package
      id: package
      run: |
        cd openwrt
        make defconfig           # ç”Ÿæˆé»˜è®¤é…ç½®
        make download -j8        # å¹¶è¡Œä¸‹è½½åŒ…ï¼ˆ8çº¿ç¨‹ï¼‰
        # æŸ¥æ‰¾å¹¶æ˜¾ç¤ºå°äº1KBçš„æ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ä¸‹è½½å¤±è´¥çš„ï¼‰ï¼Œç„¶ååˆ é™¤å®ƒä»¬
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    # 9. å¼€å§‹ç¼–è¯‘å›ºä»¶
    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"  # æ˜¾ç¤ºå¯ç”¨çš„CPUæ ¸å¿ƒæ•°
        # å°è¯•ç¼–è¯‘ï¼šå…ˆå¤šçº¿ç¨‹ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹ï¼Œå†å¤±è´¥åˆ™å•çº¿ç¨‹å¹¶æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT  # æ ‡è®°ç¼–è¯‘æˆåŠŸ
        # ä».configæ–‡ä»¶ä¸­æå–è®¾å¤‡åç§°ï¼Œå¹¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        # ç”ŸæˆåŸºäºå½“å‰æ—¶é—´çš„æ–‡ä»¶æ—¥æœŸæ ‡è®°
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    # 10. æ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µï¼ˆå¦‚æœä»»åŠ¡æœªè¢«å–æ¶ˆï¼‰
    - name: Check space usage
      if: (!cancelled())
      run: df -hT

    # 11. ä¸Šä¼ æ•´ä¸ªbinç›®å½•ä½œä¸ºæ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼Œç”±UPLOAD_BIN_DIRæ§åˆ¶ï¼‰
    - name: Upload bin directory
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}  # äº§ç‰©åç§°åŒ…å«è®¾å¤‡åå’Œæ—¥æœŸ
        path: openwrt/bin  # ä¸Šä¼ çš„ç›®å½•è·¯å¾„

    # 12. æ•´ç†å›ºä»¶æ–‡ä»¶ï¼ˆåˆ é™¤packagesç›®å½•ï¼Œä¸ºä¸Šä¼ å›ºä»¶åšå‡†å¤‡ï¼‰
    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages  # åˆ é™¤è½¯ä»¶åŒ…ç›®å½•ï¼Œåªä¿ç•™å›ºä»¶æ–‡ä»¶
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV  # è®¾ç½®å›ºä»¶ç›®å½•è·¯å¾„ä¸ºç¯å¢ƒå˜é‡
        echo "status=success" >> $GITHUB_OUTPUT

    # 13. ä¸Šä¼ å›ºä»¶ç›®å½•ä½œä¸ºæ„å»ºäº§ç‰©
    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    # 14. ç”Ÿæˆ Release çš„æ ‡ç­¾åå’Œè¯´æ˜æ–‡ä»¶
    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        # ç”ŸæˆåŸºäºæ—¥æœŸå’Œå›ºä»¶æ ‡ç­¾çš„å‘å¸ƒæ ‡ç­¾
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")-${{ env.FIRMWARE_TAG }}" >> $GITHUB_OUTPUT
        # åˆ›å»º release.txt æ–‡ä»¶ï¼ˆæ­¤å¤„æœ‰è¯­æ³•é”™è¯¯ï¼ŒUPLOAD_GOFILE å˜é‡æœªå®šä¹‰ä¸” steps.gofile ä¸å­˜åœ¨ï¼‰
        touch release.txt
        [ ${UPLOAD_GOFILE} = true && ${{ steps.gofile.outputs.url }} ] && echo "ğŸ”— [GoFile](${{ steps.gofile.outputs.url }})" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    # 15. ä¸Šä¼ å›ºä»¶åˆ° GitHub Release
    - name: Upload firmware to release
      uses: softprops/action-gh-release@master
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ GitHub Token è¿›è¡Œè®¤è¯
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}  # å‘å¸ƒæ ‡ç­¾
        body_path: release.txt                         # å‘å¸ƒè¯´æ˜æ–‡ä»¶
        files: ${{ env.FIRMWARE }}/*                   # è¦å‘å¸ƒçš„å›ºä»¶æ–‡ä»¶

    # 16. åˆ é™¤æ—§çš„ workflow è¿è¡Œè®°å½•ï¼Œåªä¿ç•™æœ€è¿‘2æ¬¡
    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0          # ä¸ä¿ç•™ä»»ä½•è¿‡å»çš„å¤©æ•°
        keep_minimum_runs: 2    # è‡³å°‘ä¿ç•™æœ€è¿‘2æ¬¡è¿è¡Œ

    # 17. åˆ é™¤æ—§çš„ Releasesï¼Œåªä¿ç•™æœ€æ–°çš„6ä¸ª
    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 6          # ä¿ç•™æœ€æ–°çš„6ä¸ªå‘å¸ƒ
        delete_tags: true       # åŒæ—¶åˆ é™¤å…³è”çš„æ ‡ç­¾
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
