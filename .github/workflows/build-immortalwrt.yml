name: Build ImmortalWrt Custom Firmware

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd

    - name: Clone ImmortalWrt source
      run: |
        git clone -b openwrt-24.10-6.6 --single-branch --filter=blob:none https://github.com/padavanonly/immortalwrt-mt798x-24.10 immortalwrt-mt798x
        cd immortalwrt-mt798x
        echo "源码克隆完成"

    - name: Download high-power config
      run: |
        cd immortalwrt-mt798x
        wget -O nx60pro-high-power.config https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-high-power.config

    - name: Setup feeds and config
      run: |
        cd immortalwrt-mt798x
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        cp nx60pro-high-power.config .config
        make defconfig
        sed -i '/CONFIG_PACKAGE_luci-app-adblock/d' .config
        sed -i '/CONFIG_PACKAGE_adblock/d' .config
        sed -i '/CONFIG_PACKAGE_docker/d' .config
        sed -i '/CONFIG_PACKAGE_dockerd/d' .config
        sed -i '/CONFIG_PACKAGE_luci-app-dockerman/d' .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-istore=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon-config=y" >> .config
        echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
        echo "CONFIG_PACKAGE_odhcp6c=y" >> .config
        echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> .config

    - name: Create config files
      run: |
        cd immortalwrt-mt798x
        mkdir -p files/etc/config
        mkdir -p files/etc/uci-defaults
        
        # 创建网络配置文件 - 使用echo逐行写入
        echo "config interface 'loopback'" > files/etc/config/network
        echo "    option device 'lo'" >> files/etc/config/network
        echo "    option proto 'static'" >> files/etc/config/network
        echo "    option ipaddr '127.0.0.1'" >> files/etc/config/network
        echo "    option netmask '255.0.0.0'" >> files/etc/config/network
        echo "" >> files/etc/config/network
        echo "config globals 'globals'" >> files/etc/config/network
        echo "    option ula_prefix 'fd10:db8:1234::/48'" >> files/etc/config/network
        echo "" >> files/etc/config/network
        echo "config device" >> files/etc/config/network
        echo "    option name 'br-lan'" >> files/etc/config/network
        echo "    option type 'bridge'" >> files/etc/config/network
        echo "    list ports 'eth0'" >> files/etc/config/network
        echo "" >> files/etc/config/network
        echo "config interface 'lan'" >> files/etc/config/network
        echo "    option device 'br-lan'" >> files/etc/config/network
        echo "    option proto 'static'" >> files/etc/config/network
        echo "    option ipaddr '192.168.6.1'" >> files/etc/config/network
        echo "    option netmask '255.255.255.0'" >> files/etc/config/network
        echo "    option ip6assign '60'" >> files/etc/config/network
        echo "" >> files/etc/config/network
        echo "config interface 'wan'" >> files/etc/config/network
        echo "    option device 'eth1'" >> files/etc/config/network
        echo "    option proto 'pppoe'" >> files/etc/config/network
        echo "    option username '15828860970'" >> files/etc/config/network
        echo "    option password '147258'" >> files/etc/config/network
        echo "    option ipv6 'auto'" >> files/etc/config/network

        # 创建无线配置文件
        echo "config wifi-device 'radio0'" > files/etc/config/wireless
        echo "    option type 'mac80211'" >> files/etc/config/wireless
        echo "    option path 'platform/18000000.wmac'" >> files/etc/config/wireless
        echo "    option channel '36'" >> files/etc/config/wireless
        echo "    option band '5g'" >> files/etc/config/wireless
        echo "    option htmode 'HE80'" >> files/etc/config/wireless
        echo "    option disabled '0'" >> files/etc/config/wireless
        echo "" >> files/etc/config/wireless
        echo "config wifi-iface 'default_radio0'" >> files/etc/config/wireless
        echo "    option device 'radio0'" >> files/etc/config/wireless
        echo "    option network 'lan'" >> files/etc/config/wireless
        echo "    option mode 'ap'" >> files/etc/config/wireless
        echo "    option ssid 'locust-5G'" >> files/etc/config/wireless
        echo "    option encryption 'psk2'" >> files/etc/config/wireless
        echo "    option key '36925888'" >> files/etc/config/wireless
        echo "" >> files/etc/config/wireless
        echo "config wifi-device 'radio1'" >> files/etc/config/wireless
        echo "    option type 'mac80211'" >> files/etc/config/wireless
        echo "    option path 'platform/18000000.wmac'" >> files/etc/config/wireless
        echo "    option channel 'auto'" >> files/etc/config/wireless
        echo "    option band '2g'" >> files/etc/config/wireless
        echo "    option htmode 'HE20'" >> files/etc/config/wireless
        echo "    option disabled '0'" >> files/etc/config/wireless
        echo "" >> files/etc/config/wireless
        echo "config wifi-iface 'default_radio1'" >> files/etc/config/wireless
        echo "    option device 'radio1'" >> files/etc/config/wireless
        echo "    option network 'lan'" >> files/etc/config/wireless
        echo "    option mode 'ap'" >> files/etc/config/wireless
        echo "    option ssid 'locust'" >> files/etc/config/wireless
        echo "    option encryption 'psk2'" >> files/etc/config/wireless
        echo "    option key '36925888'" >> files/etc/config/wireless

        # 创建系统配置文件
        echo "config system" > files/etc/config/system
        echo "    option hostname 'ImmortalWrt'" >> files/etc/config/system
        echo "    option timezone 'CST-8'" >> files/etc/config/system
        echo "    option zonename 'Asia/Shanghai'" >> files/etc/config/system
        echo "" >> files/etc/config/system
        echo "config timeserver 'ntp'" >> files/etc/config/system
        echo "    list server 'ntp.aliyun.com'" >> files/etc/config/system
        echo "    list server 'time1.cloud.tencent.com'" >> files/etc/config/system
        echo "    list server 'cn.pool.ntp.org'" >> files/etc/config/system
        echo "    option enabled '1'" >> files/etc/config/system

        # 创建防火墙配置文件
        echo "config defaults" > files/etc/config/firewall
        echo "    option syn_flood '1'" >> files/etc/config/firewall
        echo "    option input 'ACCEPT'" >> files/etc/config/firewall
        echo "    option output 'ACCEPT'" >> files/etc/config/firewall
        echo "    option forward 'REJECT'" >> files/etc/config/firewall
        echo "" >> files/etc/config/firewall
        echo "config zone" >> files/etc/config/firewall
        echo "    option name 'lan'" >> files/etc/config/firewall
        echo "    option input 'ACCEPT'" >> files/etc/config/firewall
        echo "    option output 'ACCEPT'" >> files/etc/config/firewall
        echo "    option forward 'ACCEPT'" >> files/etc/config/firewall
        echo "    option network 'lan'" >> files/etc/config/firewall
        echo "" >> files/etc/config/firewall
        echo "config zone" >> files/etc/config/firewall
        echo "    option name 'wan'" >> files/etc/config/firewall
        echo "    option input 'REJECT'" >> files/etc/config/firewall
        echo "    option output 'ACCEPT'" >> files/etc/config/firewall
        echo "    option forward 'REJECT'" >> files/etc/config/firewall
        echo "    option masq '1'" >> files/etc/config/firewall
        echo "    option mtu_fix '1'" >> files/etc/config/firewall
        echo "    option network 'wan'" >> files/etc/config/firewall
        echo "" >> files/etc/config/firewall
        echo "config forwarding" >> files/etc/config/firewall
        echo "    option src 'lan'" >> files/etc/config/firewall
        echo "    option dest 'wan'" >> files/etc/config/firewall

        # 创建自定义配置脚本
        echo "#!/bin/sh" > files/etc/uci-defaults/99-custom-config
        echo "uci set luci.main.mediaurlbase='/luci-static/argon'" >> files/etc/uci-defaults/99-custom-config
        echo "uci commit luci" >> files/etc/uci-defaults/99-custom-config
        echo "exit 0" >> files/etc/uci-defaults/99-custom-config
        chmod +x files/etc/uci-defaults/99-custom-config

    - name: Build firmware
      run: |
        cd immortalwrt-mt798x
        echo "开始编译固件，这可能需要较长时间..."
        make -j$(nproc) || make -j1 V=s
        echo "固件编译完成"

    - name: Prepare firmware for upload
      run: |
        cd immortalwrt-mt798x
        mkdir -p ../firmware-build
        cp -r bin/targets/* ../firmware-build/
        echo "固件准备完成"

    - name: Upload firmware to repository
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        git checkout firmware 2>/dev/null || git checkout -b firmware
        
        git pull origin firmware --allow-unrelated-histories 2>/dev/null || true
        
        mkdir -p firmware
        
        # 复制固件文件
        cp -r ../firmware-build/* firmware/
        
        # 创建README文件
        echo "# ImmortalWrt 自定义固件" > firmware/README.md
        echo "" >> firmware/README.md
        echo "## 构建信息" >> firmware/README.md
        echo "- 构建时间: $(date)" >> firmware/README.md
        echo "- 源码版本: padavanonly/immortalwrt-mt798x-24.10" >> firmware/README.md
        echo "- 配置文件: nx60pro-ipailna-high-power.config" >> firmware/README.md
        echo "" >> firmware/README.md
        echo "## 包含功能" >> firmware/README.md
        echo "- 高功率版本固件" >> firmware/README.md
        echo "- Argon主题" >> firmware/README.md
        echo "- OpenClash插件" >> firmware/README.md
        echo "- iStore应用商店" >> firmware/README.md
        echo "- 已移除AdBlock和Docker" >> firmware/README.md
        echo "- 预配置PPPoE拨号" >> firmware/README.md
        echo "- WiFi名称: locust / locust-5G" >> firmware/README.md
        echo "- 管理地址: 192.168.6.1" >> firmware/README.md
        echo "- IPv6自动配置" >> firmware/README.md
        echo "" >> firmware/README.md
        echo "## 刷机说明" >> firmware/README.md
        echo "请根据设备型号选择对应的固件文件刷入。" >> firmware/README.md
        
        git add firmware/
        git commit -m "添加固件构建 $(date +%Y%m%d-%H%M%S)" || echo "没有更改可提交"
        git push origin firmware

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: ../firmware-build/**/*
        tag_name: build-$(date +%Y%m%d-%H%M%S)
        name: ImmortalWrt Build $(date +%Y-%m-%d)
        body: |
          自定义ImmortalWrt固件编译完成
          
          编译时间: $(date)
          源码版本: padavanonly/immortalwrt-mt798x-24.10
          
          包含功能:
          - 高功率版本固件
          - Argon主题
          - OpenClash插件
          - iStore应用商店
          - 已移除AdBlock和Docker
          - 预配置PPPoE拨号
          - WiFi名称: locust / locust-5G
          - 管理地址: 192.168.6.1
          - IPv6自动配置
          
          固件已同时上传到 firmware 分支。
        draft: false
        prerelease: false
