name: Build ImmortalWrt Custom Firmware

on:
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]  # 推送到main分支时自动触发
  schedule:
    - cron: '0 2 * * 0'  # 每周日凌晨2点自动运行

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison \
          build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar \
          flex gawk gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged help2man \
          intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
          libmpc-dev libmpfr-dev libncurses-dev libpython3-dev libreadline-dev libssl-dev \
          libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano ninja-build p7zip \
          p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils \
          python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig \
          texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
    
    - name: Clone ImmortalWrt source
      run: |
        git clone -b openwrt-24.10-6.6 --single-branch --filter=blob:none \
          https://github.com/padavanonly/immortalwrt-mt798x-24.10 immortalwrt-mt798x
        cd immortalwrt-mt798x
        echo "源码克隆完成"
    
    - name: Download high-power config
      run: |
        cd immortalwrt-mt798x
        wget -O nx60pro-high-power.config \
          https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-high-power.config
    
    - name: Setup feeds and config
      run: |
        cd immortalwrt-mt798x
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        cp nx60pro-high-power.config .config
        
        make defconfig
        
        # 移除不需要的包
        sed -i '/CONFIG_PACKAGE_luci-app-adblock/d' .config
        sed -i '/CONFIG_PACKAGE_adblock/d' .config
        sed -i '/CONFIG_PACKAGE_docker/d' .config
        sed -i '/CONFIG_PACKAGE_dockerd/d' .config
        sed -i '/CONFIG_PACKAGE_luci-app-dockerman/d' .config
        
        # 添加需要的包
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-istore=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-argon-config=y" >> .config
        
        # IPv6支持
        echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
        echo "CONFIG_PACKAGE_odhcp6c=y" >> .config
        echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> .config
    
    - name: Create custom configuration files
      run: |
        cd immortalwrt-mt798x
        mkdir -p files/etc/config
        mkdir -p files/etc/uci-defaults
        
        # 网络配置（建议将敏感信息改为使用GitHub Secrets）
        cat > files/etc/config/network << 'EOF'
config interface 'loopback'
    option device 'lo'
    option proto 'static'
    option ipaddr '127.0.0.1'
    option netmask '255.0.0.0'

config globals 'globals'
    option ula_prefix 'fd10:db8:1234::/48'

config device
    option name 'br-lan'
    option type 'bridge'
    list ports 'eth0'

config interface 'lan'
    option device 'br-lan'
    option proto 'static'
    option ipaddr '192.168.6.1'
    option netmask '255.255.255.0'
    option ip6assign '60'

config interface 'wan'
    option device 'eth1'
    option proto 'pppoe'
    option username '15828860970'
    option password '147258'
    option ipv6 'auto'
EOF
        
        # 无线配置
        cat > files/etc/config/wireless << 'EOF'
config wifi-device 'radio0'
    option type 'mac80211'
    option path 'platform/18000000.wmac'
    option channel '36'
    option band '5g'
    option htmode 'HE80'
    option disabled '0'

config wifi-iface 'default_radio0'
    option device 'radio0'
    option network 'lan'
    option mode 'ap'
    option ssid 'locust-5G'
    option encryption 'psk2'
    option key '36925888'

config wifi-device 'radio1'
    option type 'mac80211'
    option path 'platform/18000000.wmac'
    option channel 'auto'
    option band '2g'
    option htmode 'HE20'
    option disabled '0'

config wifi-iface 'default_radio1'
    option device 'radio1'
    option network 'lan'
    option mode 'ap'
    option ssid 'locust'
    option encryption 'psk2'
    option key '36925888'
EOF
        
        # 基础配置
        cat > files/etc/uci-defaults/99-custom-config << 'EOF'
#!/bin/sh
uci set luci.main.mediaurlbase='/luci-static/argon'
uci commit luci
exit 0
EOF
        
        chmod +x files/etc/uci-defaults/99-custom-config
    
    - name: Build firmware
      run: |
        cd immortalwrt-mt798x
        echo "开始编译固件，这可能需要较长时间..."
        make -j$(nproc) || make -j1 V=s
        echo "固件编译完成"
    
    - name: Prepare firmware for upload
      run: |
        cd immortalwrt-mt798x
        # 创建固件目录并复制文件
        mkdir -p ../firmware-build
        cp -r bin/targets/* ../firmware-build/
        
        # 获取固件信息
        find bin/targets -name "*.bin" -o -name "*.img" | head -5 > ../firmware-files.txt
        echo "固件准备完成"
    
    - name: Upload firmware to repository
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 设置Git配置
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 创建或切换到firmware分支
        git checkout -b firmware 2>/dev/null || git checkout firmware
        
        # 创建固件目录
        mkdir -p firmware/$(date +%Y%m%d)
        
        # 复制固件文件
        cp -r firmware-build/* firmware/$(date +%Y%m%d)/
        
        # 创建README文件
        cat > firmware/$(date +%Y%m%d)/README.md << 'EOF'
# ImmortalWrt 自定义固件

## 构建信息
- 构建时间: $(date)
- 源码版本: padavanonly/immortalwrt-mt798x-24.10
- 配置文件: nx60pro-ipailna-high-power.config

## 包含功能
- 高功率版本固件
- Argon主题
- OpenClash插件
- iStore应用商店
- 已移除AdBlock和Docker
- 预配置PPPoE拨号
- WiFi名称: locust / locust-5G
- 管理地址: 192.168.6.1
- IPv6自动配置

## 刷机说明
请根据设备型号选择对应的固件文件刷入。

## 文件列表
EOF
        
        # 添加文件列表到README
        find firmware/$(date +%Y%m%d) -type f -name "*.bin" -o -name "*.img" | sort >> firmware/$(date +%Y%m%d)/README.md
        
        # 创建最新固件链接
        LATEST_DIR="firmware/latest"
        rm -rf $LATEST_DIR
        cp -r firmware/$(date +%Y%m%d) $LATEST_DIR
        
        # 更新总的README
        cat > firmware/README.md << 'EOF'
# ImmortalWrt 固件仓库

此仓库存放自定义编译的ImmortalWrt固件。

## 目录结构
- `latest/` - 最新编译的固件
- `YYYYMMDD/` - 按日期组织的固件版本

## 构建配置
固件基于以下配置编译：
- 源码: https://github.com/padavanonly/immortalwrt-mt798x-24.10
- 配置文件: nx60pro-ipailna-high-power.config
- 包含: Argon主题, OpenClash, iStore
- 排除: AdBlock, Docker

## 使用说明
1. 下载对应设备型号的固件
2. 通过设备管理界面刷入
3. 默认管理地址: 192.168.6.1
4. WiFi: locust / locust-5G (密码: 36925888)

## 历史版本
EOF
        
        # 添加历史版本链接
        find firmware -maxdepth 1 -type d -name "20*" | sort -r | head -10 >> firmware/README.md
        
        # 提交到仓库
        git add firmware/
        git commit -m "添加固件构建 $(date +%Y%m%d-%H%M%S)"
        git push origin firmware --force
        
        echo "固件已上传到 firmware 分支"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: github.ref == 'refs/heads/main'
      with:
        files: |
          firmware-build/**/*.bin
          firmware-build/**/*.img
        tag_name: build-$(date +%Y%m%d-%H%M%S)
        name: ImmortalWrt Build $(date +%Y-%m-%d)
        body: |
          自定义ImmortalWrt固件编译完成
          
          编译时间: $(date)
          源码版本: padavanonly/immortalwrt-mt798x-24.10
          
          包含功能:
          - 高功率版本固件
          - Argon主题
          - OpenClash插件
          - iStore应用商店
          - 已移除AdBlock和Docker
          - 预配置PPPoE拨号
          - WiFi名称: locust / locust-5G
          - 管理地址: 192.168.6.1
          - IPv6自动配置
          
          固件已同时上传到 `firmware` 分支。
        draft: false
        prerelease: false
