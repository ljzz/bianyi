name: 编译 N60 PRO 高功率固件

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: '执行完整清理编译'
        required: false
        default: false
        type: boolean

env:
  DEVICE_NAME: "CMCC N60 PRO"
  FIRMWARE_SOURCE: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  HIGH_POWER_CONFIG: "https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-high-power.config"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: 检查仓库代码
      uses: actions/checkout@v4

    - name: 准备编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget curl

    - name: 克隆源码
      run: |
        echo "正在克隆源码..."
        git clone --depth 1 --branch main $FIRMWARE_SOURCE immortalwrt
        cd immortalwrt
        echo "更新feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 应用高功率配置
      run: |
        cd immortalwrt
        echo "下载高功率配置文件..."
        wget -q -O .config "$HIGH_POWER_CONFIG"
        echo "应用默认配置..."
        make defconfig
        
        # 确认目标设备
        grep "CONFIG_TARGET_MEDIATEK_FILOGIC=y" .config && echo "✓ Filogic平台已启用"
        grep "CONFIG_TARGET_MEDIATEK_FILOGIC_DEVICE_CMCC_N60_PRO=y" .config && echo "✓ N60 PRO设备已选中"

    - name: 自定义软件包选择
      run: |
        cd immortalwrt
        echo "应用自定义软件包配置..."
        
        # 必需软件包
        cat >> .config << 'EOF'
CONFIG_PACKAGE_luci-theme-argon=y
CONFIG_PACKAGE_luci-app-openclash=y
CONFIG_PACKAGE_luci-app-istore=y
CONFIG_PACKAGE_luci-i18n-istore-zh-cn=y
CONFIG_PACKAGE_bash=y
CONFIG_PACKAGE_coreutils-nohup=y
CONFIG_PACKAGE_curl=y
EOF
        
        # 移除不需要的软件包
        cat >> .config << 'EOF'
CONFIG_PACKAGE_luci-app-adblock=n
CONFIG_PACKAGE_luci-app-docker=n
CONFIG_PACKAGE_docker=n
CONFIG_PACKAGE_dockerd=n
EOF
        
        # 清理可能的冲突
        sed -i '/CONFIG_PACKAGE_luci-app-passwall/d' .config
        sed -i '/CONFIG_PACKAGE_luci-app-ssr-plus/d' .config
        
        echo "更新配置..."
        make defconfig

    - name: 创建默认配置文件
      run: |
        echo "创建默认配置文件..."
        mkdir -p immortalwrt/files/etc/uci-defaults
        
        cat > immortalwrt/files/etc/uci-defaults/99-custom << 'EOF'
#!/bin/sh
# 自定义配置脚本

# LAN设置
uci set network.lan.ipaddr='192.168.6.1'
uci set network.lan.netmask='255.255.255.0'

# WAN - PPPoE
uci delete network.wan 2>/dev/null
uci delete network.wan6 2>/dev/null

uci set network.wan=interface
uci set network.wan.proto='pppoe'
uci set network.wan.username='15828860970'
uci set network.wan.password='147258'
uci set network.wan.ipv6='auto'
uci set network.wan.metric='10'

# IPv6设置
uci set dhcp.lan.dhcpv6='server'
uci set dhcp.lan.ra='server'
uci set dhcp.lan.ra_management='1'

# 2.4G WiFi
uci set wireless.radio0.channel='auto'
uci set wireless.radio0.htmode='HE40'
uci set wireless.default_radio0.ssid='locust'
uci set wireless.default_radio0.encryption='psk2'
uci set wireless.default_radio0.key='36925888'

# 5G WiFi
uci set wireless.radio1.channel='auto'
uci set wireless.radio1.htmode='HE160'
uci set wireless.default_radio1.ssid='locust-5G'
uci set wireless.default_radio1.encryption='psk2'
uci set wireless.default_radio1.key='36925888'

uci commit network
uci commit wireless
uci commit dhcp

exit 0
EOF
        
        chmod +x immortalwrt/files/etc/uci-defaults/99-custom

    - name: 下载依赖
      run: |
        cd immortalwrt
        echo "下载依赖包..."
        make download -j$(nproc) || make download -j1
        echo "依赖下载完成"

    - name: 编译固件
      run: |
        cd immortalwrt
        
        if ${{ github.event.inputs.clean_build }}; then
          echo "执行完整清理编译..."
          make clean
        fi
        
        echo "开始编译固件..."
        # 尝试并行编译，失败时回退到单线程详细模式
        make -j$(nproc) || make -j1 || make -j1 V=s
        
        echo "编译完成！"
        echo "输出目录内容："
        ls -la bin/targets/ || echo "bin/targets目录不存在"
        find . -name "*n60pro*" -type f | head -10 || echo "未找到n60pro相关文件"

    - name: 查找并验证固件文件
      run: |
        cd immortalwrt
        
        # 查找固件文件
        echo "查找固件文件..."
        FIND_RESULT=$(find bin/targets/ -name "*.bin" -type f 2>/dev/null | grep -i "n60pro\|cmcc" | head -5 || true)
        
        if [ -z "$FIND_RESULT" ]; then
          echo "未找到固件文件，检查所有bin文件..."
          find bin/targets/ -name "*.bin" -type f 2>/dev/null | head -10
          echo "完整目录结构："
          find bin/targets/ -type f 2>/dev/null | head -20
        else
          echo "找到固件文件："
          echo "$FIND_RESULT"
          
          # 复制到固定位置供后续使用
          mkdir -p /tmp/firmware-output
          for file in $FIND_RESULT; do
            if [[ "$file" == *sysupgrade* ]]; then
              cp "$file" /tmp/firmware-output/
              echo "已复制: $(basename "$file")"
            fi
          done
          
          ls -la /tmp/firmware-output/
        fi

    - name: 上传到Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        files: /tmp/firmware-output/*.bin
        tag_name: "n60pro-$(date +%Y%m%d-%H%M)"
        name: "N60 PRO 固件 $(date +'%Y-%m-%d %H:%M')"
        body: |
          ## CMCC N60 PRO 高功率固件
          
          **编译信息**
          - 时间: $(date)
          - 源码: ImmortalWrt 24.10
          - 配置: 高功率版本
          - 触发: 手动编译
          
          **内置功能**
          - ✅ Argon 主题
          - ✅ OpenClash
          - ✅ iStore
          - ❌ AdBlock (已移除)
          - ❌ Docker (已移除)
          
          **默认配置**
          - 管理地址: 192.168.6.1
          - WiFi 2.4G: locust (36925888)
          - WiFi 5G: locust-5G (36925888)
          - PPPoE: 已预配置
          - IPv6: 自动启用
          
          **刷机说明**
          1. 在原厂系统进入"系统升级"
          2. 选择本固件文件上传
          3. 等待3-5分钟重启
          4. 访问 http://192.168.6.1
          
          **注意事项**
          - 仅适用于CMCC N60 PRO路由器
          - 刷机前请备份重要数据
          - PPPoE账号密码已内置，请及时修改
          
          **文件校验**
          下载后请验证MD5值以确保完整性。
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 上传编译日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-$(date +%Y%m%d-%H%M%S)
        path: |
          immortalwrt/logs/
          /tmp/firmware-output/
        retention-days: 7

    - name: 编译失败通知
      if: failure()
      run: |
        echo "编译失败！请检查以下可能的原因："
        echo "1. 源码仓库可能更新，需要调整配置"
        echo "2. 依赖包下载失败"
        echo "3. 软件包冲突"
        echo ""
        echo "查看完整日志："
        echo "1. 点击上方'build-logs'下载日志"
        echo "2. 检查'编译固件'步骤的输出"
        echo "3. 查看immortalwrt目录下的编译日志"
