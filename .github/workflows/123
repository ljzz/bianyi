name: 编译 N60 PRO 高功率固件

on:
  # 仅手动触发，无定时任务
  workflow_dispatch:
    inputs:
      clean_build:
        description: '执行完整清理编译（耗时更长）'
        required: false
        default: false
        type: boolean

env:
  DEVICE_NAME: "CMCC N60 PRO"
  FIRMWARE_SOURCE: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  HIGH_POWER_CONFIG: "https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-high-power.config"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
    - name: 检查仓库代码
      uses: actions/checkout@v4

    - name: 准备编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget curl

    - name: 克隆源码
      run: |
        git clone --depth 1 --branch main $FIRMWARE_SOURCE immortalwrt
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 应用高功率配置
      run: |
        cd immortalwrt
        # 使用 raw.githubusercontent.com 直接获取配置文件
        wget -q -O .config "$HIGH_POWER_CONFIG"
        make defconfig

    - name: 自定义软件包选择
      run: |
        cd immortalwrt
        # 必需的主题和插件
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-istore=y" >> .config
        
        # OpenClash 核心依赖
        echo "CONFIG_PACKAGE_bash=y" >> .config
        echo "CONFIG_PACKAGE_coreutils-nohup=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        
        # 移除不需要的包
        echo "CONFIG_PACKAGE_luci-app-adblock=n" >> .config
        echo "CONFIG_PACKAGE_luci-app-docker=n" >> .config
        echo "CONFIG_PACKAGE_docker=n" >> .config
        
        # 清理冲突包
        sed -i '/CONFIG_PACKAGE_luci-app-passwall/d' .config
        sed -i '/CONFIG_PACKAGE_luci-app-ssr-plus/d' .config
        
        make defconfig

    - name: 创建默认配置文件
      run: |
        mkdir -p immortalwrt/files/etc/uci-defaults
        
        cat > immortalwrt/files/etc/uci-defaults/99-custom << 'EOF'
        #!/bin/sh
        # LAN 设置
        uci set network.lan.ipaddr='192.168.6.1'
        
        # PPPoE
        uci set network.wan.proto='pppoe'
        uci set network.wan.username='15828860970'
        uci set network.wan.password='147258'
        
        # IPv6
        uci set network.wan.ipv6='auto'
        uci set dhcp.lan.dhcpv6='server'
        uci set dhcp.lan.ra='server'
        
        # WiFi 2.4G
        uci set wireless.default_radio0.ssid='locust'
        uci set wireless.default_radio0.key='36925888'
        
        # WiFi 5G
        uci set wireless.default_radio1.ssid='locust-5G'
        uci set wireless.default_radio1.key='36925888'
        
        uci commit
        exit 0
        EOF
        
        chmod +x immortalwrt/files/etc/uci-defaults/99-custom

    - name: 下载依赖
      run: |
        cd immortalwrt
        make download -j$(nproc) || make download -j1

    - name: 编译固件
      run: |
        cd immortalwrt
        if ${{ github.event.inputs.clean_build }}; then
          echo "执行完整清理编译..."
          make clean
          make dirclean
        fi
        
        echo "开始编译..."
        make -j$(nproc) || make -j1 V=s

    - name: 准备发布文件
      run: |
        cd immortalwrt/bin/targets/mediatek/filogic/*/
        
        # 查找固件文件
        for file in *sysupgrade.bin; do
          if [ -f "$file" ]; then
            # 重命名固件
            new_name="immortalwrt-n60pro-$(date +%Y%m%d-%H%M).bin"
            cp "$file" "$new_name"
            
            # 生成校验文件
            md5sum "$new_name" > "$new_name.md5"
            sha256sum "$new_name" > "$new_name.sha256"
            
            echo "固件已准备: $new_name"
          fi
        done

    - name: 上传到仓库分支
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 克隆你的仓库
        git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/ljzz/bianyi.git release-repo
        cd release-repo
        
        # 准备固件目录
        mkdir -p firmware/n60pro/$(date +%Y%m%d)
        cp -r ../../immortalwrt/bin/targets/mediatek/filogic/*/* firmware/n60pro/$(date +%Y%m%d)/
        
        # 更新索引文件
        echo "# N60 PRO 固件存档" > firmware/README.md
        echo "最新编译: $(date)" >> firmware/README.md
        echo "" >> firmware/README.md
        find firmware/n60pro -name "*.bin" | sort -r >> firmware/README.md
        
        # 提交更新
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "添加固件: $(date +%Y%m%d-%H%M%S)"
        git push origin main

    - name: 创建发布版本
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        files: immortalwrt/bin/targets/mediatek/filogic/*/*
        tag_name: "n60pro-$(date +%Y%m%d-%H%M)"
        name: "N60 PRO 固件 $(date +'%Y年%m月%d日 %H:%M')"
        body: |
          ## 手动编译的 N60 PRO 高功率固件
          
          **编译时间**: $(date)
          
          **配置摘要**:
          - 设备: CMCC N60 PRO
          - 源码: ImmortalWrt 24.10
          - 配置: 高功率版本
          - 包含: Argon 主题, OpenClash, iStore
          - 排除: AdBlock, Docker
          
          **网络预设**:
          - 管理地址: 192.168.6.1
          - WiFi 2.4G: locust
          - WiFi 5G: locust-5G
          - 统一密码: 36925888
          - PPPoE 已预配
          
          **刷机注意**: 仅适用于 N60 PRO 原厂系统升级！
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
