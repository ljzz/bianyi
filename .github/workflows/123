name: Build N60 Pro

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build_n60pro.yml'
      - 'config/**'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag'
        required: true
        default: 'v1.0.0'

env:
  SOURCE_REPO: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  SOURCE_BRANCH: "main"
  HIGH_POWER_CONFIG_URL: "https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-high-power.config"
  BUILD_DIR: "${{ github.workspace }}/immortalwrt"  # è¿™æ˜¯å…³é”®ï¼Œç¡®ä¿æ‰€æœ‰æ­¥éª¤ä½¿ç”¨ç›¸åŒçš„è·¯å¾„
  TARGET_SUBTARGET: "mediatek/mt7986"
  TARGET_PROFILE: "glinet_gl-mt6000"

jobs:
  build-and-release:
    runs-on: ubuntu-22.04
    timeout-minutes: 210
    
    steps:
    - name: æ£€å‡ºä»“åº“é…ç½®
      uses: actions/checkout@v4
      with:
        path: config-repo

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache clang flex bison g++ gawk \
          gcc-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils python3-pip rsync unzip \
          zlib1g-dev file wget curl jq upx

    - name: å…‹éš†237æºç 
      run: |
        echo "å…‹éš†æºç åˆ° $BUILD_DIR..."
        rm -rf "$BUILD_DIR"
        git clone --depth=1 --branch="$SOURCE_BRANCH" "$SOURCE_REPO" "$BUILD_DIR"
        cd "$BUILD_DIR"
        COMMIT_HASH=$(git rev-parse --short HEAD)
        COMMIT_DATE=$(git log -1 --format=%cd --date=short)
        echo "æºç ç‰ˆæœ¬: $COMMIT_HASH ($COMMIT_DATE)"
        echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
        echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV

    - name: é…ç½®feeds
      run: |
        cd "$BUILD_DIR"
        echo "æ·»åŠ iStoreå’ŒOpenClashæº..."
        cat >> feeds.conf.default << 'EOF'
src-git istore https://github.com/linkease/istore.git;main
src-git openclash https://github.com/vernesong/OpenClash.git;master
EOF
        
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        ./scripts/feeds install -f luci-app-store
        ./scripts/feeds install -f luci-app-openclash

    - name: åº”ç”¨ç¼–è¯‘é…ç½®
      run: |
        cd "$BUILD_DIR"
        
        echo "ä¸‹è½½é«˜åŠŸçŽ‡é…ç½®..."
        curl -L -s -o .config "$HIGH_POWER_CONFIG_URL"
        
        if [ ! -s .config ]; then
          echo "âŒ é…ç½®æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        echo "åº”ç”¨è‡ªå®šä¹‰é…ç½®..."
        
        # 1. åªç¼–è¯‘ GL-MT6000
        sed -i '/CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_/d' .config
        echo "CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_glinet_gl-mt6000=y" >> .config
        sed -i 's/CONFIG_TARGET_MULTI_PROFILE=y/# CONFIG_TARGET_MULTI_PROFILE is not set/' .config
        
        # 2. è¿½åŠ è‡ªå®šä¹‰é…ç½®
        cat >> .config << 'EOF'
# åŸºç¡€ç½‘ç»œ
CONFIG_TARGET_IPV6_IP6TABLE=y

# PPPoEæ”¯æŒ
CONFIG_PACKAGE_kmod-ppp=y
CONFIG_PACKAGE_kmod-pppoe=y
CONFIG_PACKAGE_ppp-mod-pppoe=y
CONFIG_PACKAGE_luci-proto-ppp=y

# IPv6æ”¯æŒ
CONFIG_PACKAGE_ipv6helper=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_luci-proto-ipv6=y

# LuCIåŸºç¡€ + Argonä¸»é¢˜
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-argon=y

# iStoreå•†åº—
CONFIG_PACKAGE_luci-app-store=y

# OpenClash
CONFIG_PACKAGE_luci-app-openclash=y
CONFIG_PACKAGE_luci-app-openclash_Master=y
CONFIG_PACKAGE_coreutils-nohup=y
CONFIG_PACKAGE_bash=y
CONFIG_PACKAGE_iptables-mod-tproxy=y
CONFIG_PACKAGE_ipset=y
CONFIG_PACKAGE_curl=y

# è®¾å¤‡ä¸“ç”¨
CONFIG_PACKAGE_luci-app-mtwifi-cfg=y
CONFIG_PACKAGE_luci-app-turboacc-mtk=y

# æ˜Žç¡®ç¦ç”¨ä¸éœ€è¦çš„
# CONFIG_PACKAGE_luci-app-adblock is not set
# CONFIG_PACKAGE_luci-app-dockerman is not set
# CONFIG_PACKAGE_docker-ce is not set
# CONFIG_PACKAGE_luci-app-upnp is not set
# CONFIG_PACKAGE_luci-app-ddns is not set
EOF

    - name: ç”Ÿæˆæœ€ç»ˆé…ç½®
      run: |
        cd "$BUILD_DIR"
        make defconfig
        echo "é…ç½®æ‘˜è¦:"
        ./scripts/diffconfig.sh | head -30

    - name: å…¨æ–°ç¼–è¯‘å‡†å¤‡
      run: |
        cd "$BUILD_DIR"
        echo "æ‰§è¡Œå…¨æ–°ç¼–è¯‘..."
        make clean
        echo "ä¸‹è½½è½¯ä»¶åŒ…..."
        make download -j$(nproc) || make download -j1

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd "$BUILD_DIR"
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        START_TIME=$(date +%s)
        
        # ä¼˜åŒ–çº¿ç¨‹æ•°
        CPU_CORES=$(nproc)
        if [ $CPU_CORES -gt 4 ]; then
          MAKE_JOBS=4
        else
          MAKE_JOBS=$CPU_CORES
        fi
        
        echo "ä½¿ç”¨ç¼–è¯‘çº¿ç¨‹æ•°: $MAKE_JOBS"
        make -j$MAKE_JOBS V=s 2>&1 | tee build.log
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "ç¼–è¯‘è€—æ—¶: $(($DURATION / 60))åˆ†$(($DURATION % 60))ç§’"

    # å…³é”®æ­¥éª¤ï¼šæŸ¥æ‰¾å›ºä»¶æ–‡ä»¶å¹¶éªŒè¯
    - name: æŸ¥æ‰¾å¹¶éªŒè¯å›ºä»¶æ–‡ä»¶
      id: find_firmware
      run: |
        echo "===== æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶ ====="
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "æž„å»ºç›®å½•: $BUILD_DIR"
        
        # è¿›å…¥æž„å»ºç›®å½•
        cd "$BUILD_DIR"
        
        # æ£€æŸ¥ç›®å½•ç»“æž„
        echo "ç›®å½•ç»“æž„:"
        find . -maxdepth 3 -type d | sort
        
        # æŸ¥æ‰¾æ‰€æœ‰.binæ–‡ä»¶
        echo "æŸ¥æ‰¾æ‰€æœ‰.binæ–‡ä»¶..."
        find . -name "*.bin" -type f 2>/dev/null
        
        # æŸ¥æ‰¾ç›®æ ‡ç›®å½•ä¸­çš„å›ºä»¶
        TARGET_PATH="bin/targets/$TARGET_SUBTARGET"
        echo "ç›®æ ‡è·¯å¾„: $TARGET_PATH"
        
        if [ -d "$TARGET_PATH" ]; then
          echo "âœ… ç›®æ ‡ç›®å½•å­˜åœ¨"
          echo "ç›®æ ‡ç›®å½•å†…å®¹:"
          ls -la "$TARGET_PATH/"
          
          # æŸ¥æ‰¾å…·ä½“çš„å›ºä»¶æ–‡ä»¶
          FIRMWARE_FILE=$(find "$TARGET_PATH" -name "*.bin" -type f | head -1)
          
          if [ -n "$FIRMWARE_FILE" ] && [ -f "$FIRMWARE_FILE" ]; then
            FIRMWARE_NAME=$(basename "$FIRMWARE_FILE")
            FIRMWARE_SIZE=$(ls -lh "$FIRMWARE_FILE" | awk '{print $5}')
            
            echo "âœ… æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
            echo "æ–‡ä»¶å: $FIRMWARE_NAME"
            echo "æ–‡ä»¶å¤§å°: $FIRMWARE_SIZE"
            echo "å®Œæ•´è·¯å¾„: $FIRMWARE_FILE"
            
            # è®¾ç½®è¾“å‡ºå˜é‡
            echo "firmware_path=$FIRMWARE_FILE" >> $GITHUB_OUTPUT
            echo "firmware_name=$FIRMWARE_NAME" >> $GITHUB_OUTPUT
            echo "firmware_size=$FIRMWARE_SIZE" >> $GITHUB_OUTPUT
          else
            echo "âŒ ç›®æ ‡ç›®å½•ä¸­æ²¡æœ‰.binæ–‡ä»¶"
            echo "ç›®æ ‡ç›®å½•å†…å®¹è¯¦æƒ…:"
            find "$TARGET_PATH" -type f 2>/dev/null
            exit 1
          fi
        else
          echo "âŒ ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: $TARGET_PATH"
          echo "binç›®å½•å†…å®¹:"
          find . -type d -name "bin" -exec ls -la {} \;
          exit 1
        fi

    - name: éªŒè¯å›ºä»¶æ–‡ä»¶å­˜åœ¨
      run: |
        echo "éªŒè¯å›ºä»¶æ–‡ä»¶å­˜åœ¨..."
        FIRMWARE_PATH="${{ steps.find_firmware.outputs.firmware_path }}"
        
        if [ -z "$FIRMWARE_PATH" ]; then
          echo "âŒ å›ºä»¶è·¯å¾„ä¸ºç©º"
          exit 1
        fi
        
        if [ ! -f "$FIRMWARE_PATH" ]; then
          echo "âŒ å›ºä»¶æ–‡ä»¶ä¸å­˜åœ¨: $FIRMWARE_PATH"
          exit 1
        fi
        
        echo "âœ… å›ºä»¶æ–‡ä»¶å­˜åœ¨: $FIRMWARE_PATH"
        echo "æ–‡ä»¶å¤§å°: $(ls -lh "$FIRMWARE_PATH" | awk '{print $5}')"

    - name: åˆ›å»ºGitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.event.inputs.tag_name || 'v1.0.0' }}
        name: "N60 Proå›ºä»¶ ${{ github.event.inputs.tag_name || 'v1.0.0' }}"
        body: |
          # N60 Pro å®šåˆ¶å›ºä»¶
          
          ## ç¼–è¯‘ä¿¡æ¯
          - **ç¼–è¯‘æ—¶é—´**: $(date "+%Y-%m-%d %H:%M:%S")
          - **ç¼–è¯‘ç¼–å·**: ${{ github.run_number }}
          - **æºç ç‰ˆæœ¬**: ${{ env.COMMIT_HASH }} (${{ env.COMMIT_DATE }})
          - **è®¾å¤‡åž‹å·**: GL.iNet GL-MT6000 (N60 Pro)
          
          ## é¢„é…ç½®è¯¦æƒ…
          - **ç®¡ç†åœ°å€**: 192.168.6.1
          - **PPPoEè´¦å·**: 15828860970
          - **PPPoEå¯†ç **: 147258
          - **WiFi 2.4G**: locust (å¯†ç : 36925888)
          - **WiFi 5G**: locust-5G (å¯†ç : 36925888)
          - **IPv6æ”¯æŒ**: è‡ªåŠ¨å¯ç”¨
          
          ## é¢„è£…æ’ä»¶
          1. iStore åº”ç”¨å•†åº—
          2. OpenClash ä»£ç†å·¥å…·
          
          ## ä¸»é¢˜
          - Argon çŽ°ä»£ä¸»é¢˜
          
          ## åˆ·æœºæ­¥éª¤
          1. ä¸‹è½½æœ¬é¡µé¢ä¸­çš„å›ºä»¶æ–‡ä»¶
          2. è®¿é—®è·¯ç”±å™¨åŽŸç®¡ç†ç•Œé¢
          3. ç³»ç»Ÿ â†’ å¤‡ä»½/å‡çº§ â†’ åˆ·å†™å›ºä»¶
          4. **ä¸ä¿ç•™é…ç½®**åˆ·å…¥
          5. ç­‰å¾…é‡å¯å®Œæˆ
        draft: false
        prerelease: false
        generate_release_notes: true

    # å…³é”®ï¼šä½¿ç”¨æ­£ç¡®çš„è·¯å¾„ä¸Šä¼ å›ºä»¶
    - name: ä¸Šä¼ å›ºä»¶åˆ°Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.find_firmware.outputs.firmware_path }}
        asset_name: ${{ steps.find_firmware.outputs.firmware_name }}
        asset_content_type: application/octet-stream

    - name: åˆ›å»ºé…ç½®æ–‡ä»¶
      run: |
        echo "åˆ›å»ºé…ç½®æ–‡ä»¶..."
        
        # åˆ›å»ºé…ç½®ç›®å½•
        mkdir -p config
        
        # åˆ›å»ºç½‘ç»œé…ç½®
        cat > config/network << 'EOF'
config interface 'loopback'
    option ifname 'lo'
    option proto 'static'
    option ipaddr '127.0.0.1'
    option netmask '255.0.0.0'

config interface 'lan'
    option ifname 'eth1'
    option proto 'static'
    option ipaddr '192.168.6.1'
    option netmask '255.255.255.0'
    option ip6assign '60'

config interface 'wan'
    option ifname 'eth0'
    option proto 'pppoe'
    option username '15828860970'
    option password '147258'
    option ipv6 'auto'

config interface 'wan6'
    option ifname '@wan'
    option proto 'dhcpv6'
EOF

        # åˆ›å»ºæ— çº¿é…ç½®
        cat > config/wireless << 'EOF'
config wifi-device 'radio0'
    option type 'mac80211'
    option path '1e140000.pcie'
    option channel '36'
    option band '5g'
    option htmode 'HE160'
    option disabled '0'

config wifi-iface 'default_radio0'
    option device 'radio0'
    option network 'lan'
    option mode 'ap'
    option ssid 'locust-5G'
    option encryption 'psk2'
    option key '36925888'

config wifi-device 'radio1'
    option type 'mac80211'
    option path '18000000.wmac'
    option channel '11'
    option band '2g'
    option htmode 'HE40'
    option disabled '0'

config wifi-iface 'default_radio1'
    option device 'radio1'
    option network 'lan'
    option mode 'ap'
    option ssid 'locust'
    option encryption 'psk2'
    option key '36925888'
EOF

        # åˆ›å»ºç³»ç»Ÿé…ç½®
        cat > config/system << 'EOF'
config system
    option hostname 'N60Pro'
    option timezone 'CST-8'
    option zonename 'Asia/Shanghai'
EOF

        # åˆ›å»ºArgonä¸»é¢˜é…ç½®
        cat > config/argon << 'EOF'
config global
    option blur '1'
    option shadow '1'
    option transparency '1'
EOF

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°ä»“åº“
      uses: actions/upload-artifact@v4
      with:
        name: config-files
        path: config/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 7

    - name: ç¼–è¯‘å®Œæˆé€šçŸ¥
      if: success()
      run: |
        echo "========================================"
        echo "ðŸŽ‰ N60 Proå›ºä»¶ç¼–è¯‘æˆåŠŸ!"
        echo "========================================"
        echo "å›ºä»¶ä¿¡æ¯:"
        echo "- æ–‡ä»¶å: ${{ steps.find_firmware.outputs.firmware_name }}"
        echo "- æ–‡ä»¶å¤§å°: ${{ steps.find_firmware.outputs.firmware_size }}"
        echo "- æºç ç‰ˆæœ¬: ${{ env.COMMIT_HASH }} (${{ env.COMMIT_DATE }})"
        echo ""
        echo "å›ºä»¶å·²å‘å¸ƒåˆ°:"
        echo "https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.tag_name || 'v1.0.0' }}"
        echo ""
        echo "ðŸ“‹ é…ç½®æ–‡ä»¶å·²ä¿å­˜åœ¨ä»“åº“ä¸­"
        echo "========================================"
