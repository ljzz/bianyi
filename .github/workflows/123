name: Build N60 PRO Firmware1

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Clean build (true/false)'
        required: false
        default: 'false'
        type: string

env:
  SOURCE_URL: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  HIGH_POWER_CONFIG: "https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-highpower.config"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-pip rsync unzip zlib1g-dev file wget curl

    - name: Clone source code
      run: |
        git clone --depth 1 --branch main $SOURCE_URL openwrt-build
        cd openwrt-build
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply config
      run: |
        cd openwrt-build
        wget -q -O .config "$HIGH_POWER_CONFIG"
        echo "CONFIG_TARGET_MEDIATEK_FILOGIC=y" >> .config
        echo "CONFIG_TARGET_MEDIATEK_FILOGIC_DEVICE_CMCC_N60_PRO=y" >> .config
        make defconfig

    - name: Configure packages
      run: |
        cd openwrt-build
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-istore=y" >> .config
        echo "CONFIG_PACKAGE_bash=y" >> .config
        echo "CONFIG_PACKAGE_coreutils-nohup=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-adblock=n" >> .config
        echo "CONFIG_PACKAGE_luci-app-docker=n" >> .config
        make defconfig

    - name: Create config files using Python
      run: |
        mkdir -p openwrt-build/files/etc/uci-defaults
        python3 -c "
config = '''#!/bin/sh
uci set network.lan.ipaddr='192.168.6.1'
uci set network.lan.netmask='255.255.255.0'
uci delete network.wan 2>/dev/null || true
uci set network.wan=interface
uci set network.wan.proto='pppoe'
uci set network.wan.username='15828860970'
uci set network.wan.password='147258'
uci set network.wan.ipv6='auto'
uci set dhcp.lan.dhcpv6='server'
uci set dhcp.lan.ra='server'
uci set wireless.default_radio0.ssid='locust'
uci set wireless.default_radio0.key='36925888'
uci set wireless.default_radio0.encryption='psk2'
uci set wireless.default_radio1.ssid='locust-5G'
uci set wireless.default_radio1.key='36925888'
uci set wireless.default_radio1.encryption='psk2'
uci commit
exit 0
'''
with open('openwrt-build/files/etc/uci-defaults/99-custom', 'w') as f:
    f.write(config)
"
        chmod +x openwrt-build/files/etc/uci-defaults/99-custom

    - name: Download dependencies
      run: |
        cd openwrt-build
        make download -j$(nproc) || make download -j1

    - name: Compile firmware
      run: |
        cd openwrt-build
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "Performing clean build..."
          make clean
        fi
        echo "Starting compilation..."
        make -j$(nproc) || make -j1 V=s
        echo "Compilation complete!"

    - name: Find and copy firmware
      run: |
        cd openwrt-build
        # Look for firmware
        find_result=$(find . -name "*.bin" -type f | grep -i "n60pro\|cmcc" | head -5)
        if [ -n "$find_result" ]; then
          echo "Found firmware:"
          echo "$find_result"
          mkdir -p /tmp/firmware_output
          for f in $find_result; do
            cp "$f" /tmp/firmware_output/
          done
        else
          echo "No firmware found with expected name, listing all .bin files:"
          find . -name "*.bin" -type f | head -20
        fi

    - name: Upload to repository
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Clone target repo
        git clone https://x-access-token:$GITHUB_TOKEN@github.com/ljzz/bianyi.git repo
        cd repo
        
        # Create or clear firmware directory
        mkdir -p firmware
        rm -rf firmware/*
        
        # Copy any firmware found
        if [ -d "/tmp/firmware_output" ]; then
          cp /tmp/firmware_output/*.bin firmware/ 2>/dev/null || true
        fi
        
        # Create README
        echo "# N60 PRO 固件" > firmware/README.md
        echo "编译时间: $(date)" >> firmware/README.md
        echo "" >> firmware/README.md
        echo "包含插件:" >> firmware/README.md
        echo "- Argon 主题" >> firmware/README.md
        echo "- OpenClash" >> firmware/README.md
        echo "- iStore" >> firmware/README.md
        echo "" >> firmware/README.md
        echo "默认配置:" >> firmware/README.md
        echo "- 管理地址: 192.168.6.1" >> firmware/README.md
        echo "- WiFi 2.4G: locust (密码: 36925888)" >> firmware/README.md
        echo "- WiFi 5G: locust-5G (密码: 36925888)" >> firmware/README.md
        echo "- PPPoE: 已预配置" >> firmware/README.md
        echo "- IPv6: 自动启用" >> firmware/README.md
        
        # List files
        echo "" >> firmware/README.md
        echo "文件列表:" >> firmware/README.md
        ls -la firmware/*.bin 2>/dev/null >> firmware/README.md || echo "暂无固件文件" >> firmware/README.md
        
        # Commit and push
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add firmware/
        git commit -m "更新固件: $(date +%Y%m%d-%H%M%S)"
        git push origin main
        
        echo "✅ 固件已上传到 https://github.com/ljzz/bianyi/tree/main/firmware"
