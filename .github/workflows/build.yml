name: 编译 N60 PRO 固件
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 1. 验证并安装基础工具
        run: |
          echo "检查基础命令..."
          command -v make >/dev/null 2>&1 || echo "make 未安装"
          command -v git >/dev/null 2>&1 || echo "git 未安装"
          command -v wget >/dev/null 2>&1 || echo "wget 未安装"
          
          echo "更新软件源并安装必要工具..."
          sudo apt-get update
          sudo apt-get install -y build-essential git wget curl
          echo "✅ 基础工具安装完成"

      - name: 2. 克隆 OpenWrt 源码
        run: |
          echo "正在克隆源码..."
          git clone --depth=1 https://github.com/padavanonly/immortalwrt-mt798x-24.10 openwrt
          if [ -d "openwrt" ]; then
            echo "✅ 源码克隆成功"
            ls -la openwrt/
          else
            echo "❌ 源码克隆失败"
            exit 1
          fi

      - name: 3. 初始化 OpenWrt feeds
        run: |
          cd openwrt
          echo "更新 feeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "✅ feeds 初始化完成"

      - name: 4. 配置目标与软件包
        run: |
          cd openwrt
          echo "生成基础配置..."
          # 创建一个极简的 .config 文件
          cat > .config << 'EOF'
CONFIG_TARGET_MEDIATEK_FILOGIC=y
CONFIG_TARGET_MEDIATEK_FILOGIC_DEVICE_CMCC_N60_PRO=y
CONFIG_PACKAGE_luci-theme-argon=y
CONFIG_PACKAGE_luci-app-openclash=y
CONFIG_PACKAGE_luci-app-istore=y
EOF
          echo "应用配置..."
          make defconfig
          echo "✅ 设备与软件包配置完成"

      - name: 5. 创建网络配置文件
        run: |
          cd openwrt
          mkdir -p files/etc/uci-defaults
          # 写入您的自定义网络配置
          cat > files/etc/uci-defaults/99-custom << 'EOF'
#!/bin/sh
uci set network.lan.ipaddr='192.168.6.1'
uci set network.lan.netmask='255.255.255.0'
uci set network.wan.proto='pppoe'
uci set network.wan.username='15828860970'
uci set network.wan.password='147258'
uci set network.wan.ipv6='auto'
uci set dhcp.lan.dhcpv6='server'
uci set dhcp.lan.ra='server'
uci set wireless.default_radio0.ssid='locust'
uci set wireless.default_radio0.key='36925888'
uci set wireless.default_radio0.encryption='psk2'
uci set wireless.default_radio1.ssid='locust-5G'
uci set wireless.default_radio1.key='36925888'
uci set wireless.default_radio1.encryption='psk2'
uci commit
exit 0
EOF
          chmod +x files/etc/uci-defaults/99-custom
          echo "✅ 网络配置文件创建完成"

      - name: 6. 下载编译依赖
        run: |
          cd openwrt
          echo "开始下载依赖包 (这需要几分钟)..."
          make download -j2
          echo "✅ 依赖下载完成"

      - name: 7. 编译固件
        run: |
          cd openwrt
          echo "开始编译固件 (这需要较长时间，请耐心等待)..."
          make -j2 || make -j1 V=s
          echo "编译进程结束"

      - name: 8. 收集并上传固件
        run: |
          echo "查找生成的固件文件..."
          mkdir -p firmware_output
          # 尝试多种可能的文件名模式
          find openwrt/bin -name "*n60pro*.bin" -exec cp {} firmware_output/ \; 2>/dev/null || true
          find openwrt/bin -name "*cmcc*.bin" -exec cp {} firmware_output/ \; 2>/dev/null || true
          find openwrt/bin -name "*sysupgrade.bin" -exec cp {} firmware_output/ \; 2>/dev/null || true
          
          if [ -n "$(ls -A firmware_output 2>/dev/null)" ]; then
            echo "✅ 找到固件文件:"
            ls -lh firmware_output/
          else
            echo "⚠️  未在标准路径找到固件，正在列出编译输出目录..."
            find openwrt/bin -type f -name "*.bin" | head -10
          fi

      - name: 9. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: n60pro-firmware
          path: firmware_output/
