name: Build ImmortalWrt with Docker

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build OpenWrt Image
        uses: docker-openwrt-buildaction@v2
        with:
          # 237的高功率固件源码
          openwrt-repo: https://github.com/padavanonly/immortalwrt-mt798x-24.10
          openwrt-branch: openwrt-24.10-6.6
          # 你的高功率配置文件（需要先上传到你的仓库）
          config-file: config/nx60pro-high-power.config
          # 自定义你的软件包列表
          packages: |
            luci-app-openclash
            luci-app-istore
            luci-theme-argon
            luci-theme-argon-config
            ipv6helper
          # 排除不需要的软件包
          disable-packages: |
            adblock
            luci-app-adblock
            docker
            dockerd
            luci-app-dockerman

      - name: Upload firmware to repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout firmware 2>/dev/null || git checkout -b firmware
          mkdir -p firmware/latest
          # 假设Action输出固件到 './bin' 目录
          cp -r ./bin/targets/* firmware/latest/ || echo "No firmware found to copy."
          git add firmware/
          git commit -m "Update firmware $(date +%Y%m%d-%H%M%S)" || echo "No changes"
          git push origin firmware
