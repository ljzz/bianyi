name: Build N60 Pro (Full Edition)

on:
  # å½“æ­¤å·¥ä½œæµæ–‡ä»¶è¢«æ¨é€åˆ°ä»“åº“æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/build_n60pro_full.yml'
  # æ”¯æŒåœ¨GitHubç½‘é¡µä¸Šæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  SOURCE_REPO: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  SOURCE_BRANCH: "main"
  HIGH_POWER_CONFIG_URL: "https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-high-power.config"
  BUILD_DIR: "${{ github.workspace }}/immortalwrt"
  TARGET_SUBTARGET: "mediatek/mt7986"
  TARGET_PROFILE: "glinet_gl-mt6000"

jobs:
  build:
    name: ç¼–è¯‘ N60 Pro å®Œæ•´åŠŸèƒ½å›ºä»¶
    runs-on: ubuntu-22.04
    timeout-minutes: 240 # è®¾ç½®ä¸º4å°æ—¶ï¼Œç¼–è¯‘å¯èƒ½è€—æ—¶è¾ƒé•¿

    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºå·¥ä½œæµä»“åº“æœ¬èº«
    - name: Checkout workflow repo
      uses: actions/checkout@v4
      with:
        path: workflow-configs

    # æ­¥éª¤2ï¼šå®‰è£…å¿…è¦çš„ç¼–è¯‘å·¥å…·å’Œä¾èµ–
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache clang flex bison g++ gawk \
        gcc-multilib gettext git libncurses5-dev libssl-dev python3 python3-distutils \
        python3-pip rsync unzip zlib1g-dev file wget curl jq upx

    # æ­¥éª¤3ï¼šå…‹éš†237çš„æºç 
    - name: Clone 237 source
      run: |
        echo "æ­£åœ¨å…‹éš†æºç ä»“åº“: $SOURCE_REPO"
        rm -rf "$BUILD_DIR"
        git clone --depth=1 --branch="$SOURCE_BRANCH" "$SOURCE_REPO" "$BUILD_DIR"

    # æ­¥éª¤4ï¼šé…ç½®é¢å¤–çš„è½¯ä»¶æº (Feeds)
    - name: Configure additional feeds
      run: |
        cd "$BUILD_DIR"
        echo "æ·»åŠ  iStore å’Œ OpenClash è½¯ä»¶æº..."
        # æ·»åŠ  iStore è½¯ä»¶æºï¼ˆæ¥è‡ªLinkEaseï¼‰
        echo "src-git istore https://github.com/linkease/istore.git;main" >> feeds.conf.default
        # æ·»åŠ  OpenClash è½¯ä»¶æº
        echo "src-git openclash https://github.com/vernesong/OpenClash.git;master" >> feeds.conf.default
        # æ·»åŠ ä¸€ä¸ªå¸¸ç”¨çš„ç¬¬ä¸‰æ–¹è½¯ä»¶æºä»¥è·å–æ›´å¤šæ’ä»¶
        echo "src-git small https://github.com/kenzok8/small-package" >> feeds.conf.default
        cat feeds.conf.default

    # æ­¥éª¤5ï¼šæ›´æ–°å¹¶å®‰è£…æ‰€æœ‰è½¯ä»¶åŒ…
    - name: Update and install feeds
      run: |
        cd "$BUILD_DIR"
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # æ­¥éª¤6ï¼šä¸‹è½½å¹¶åº”ç”¨é«˜åŠŸç‡åŸºç¡€é…ç½®
    - name: Apply high-power base config
      run: |
        cd "$BUILD_DIR"
        echo "ä¸‹è½½é«˜åŠŸç‡åŸºç¡€é…ç½®æ–‡ä»¶..."
        wget -O .config "$HIGH_POWER_CONFIG_URL"

        echo "å¼€å§‹åº”ç”¨è‡ªå®šä¹‰é…ç½®..."
        # 6.1 ç¡®ä¿åªç¼–è¯‘ GL-MT6000 (N60 Pro)
        sed -i '/CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_/d' .config
        echo "CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_glinet_gl-mt6000=y" >> .config
        # ç¦ç”¨å¤šè®¾å¤‡ç¼–è¯‘ä»¥èŠ‚çœæ—¶é—´
        sed -i 's/CONFIG_TARGET_MULTI_PROFILE=y/# CONFIG_TARGET_MULTI_PROFILE is not set/' .config

        # 6.2 é…ç½® LAN å£ IP ä¸º 192.168.6.1
        # æ­¤é…ç½®ä¼šåœ¨ç¼–è¯‘æ—¶è®¾ç½®é»˜è®¤çš„ LAN å£åœ°å€
        cat >> .config << 'EOF'
# è®¾ç½®é»˜è®¤ LAN IP ä¸º 192.168.6.1
CONFIG_TARGET_IPV6_IP6TABLE=y
CONFIG_TARGET_PREINIT_IP="192.168.6.1"
CONFIG_TARGET_PREINIT_SUBNET="255.255.255.0"
EOF

        # 6.3 å¯ç”¨ PPPoE ç›¸å…³å†…æ ¸æ¨¡å—å’Œç”¨æˆ·æ€å·¥å…·
        cat >> .config << 'EOF'
# PPPoE æ‹¨å·æ”¯æŒ
CONFIG_PACKAGE_kmod-ppp=y
CONFIG_PACKAGE_kmod-pppoe=y
CONFIG_PACKAGE_kmod-pppox=y
CONFIG_PACKAGE_ppp=y
CONFIG_PACKAGE_ppp-mod-pppoe=y
CONFIG_PACKAGE_luci-proto-ppp=y
EOF

        # 6.4 å¯ç”¨å®Œæ•´çš„ IPv6 æ”¯æŒ
        cat >> .config << 'EOF'
# å®Œæ•´ IPv6 æ”¯æŒ
CONFIG_PACKAGE_ipv6helper=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_luci-proto-ipv6=y
CONFIG_PACKAGE_ip6tables=y
CONFIG_PACKAGE_ip6tables-mod-nat=y
CONFIG_PACKAGE_6in4=y
EOF

        # 6.5 å¯ç”¨ LuCI ç½‘é¡µç•Œé¢ã€iStore å’Œ OpenClash
        cat >> .config << 'EOF'
# LuCI åŸºç¡€ç•Œé¢
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-argon=y

# iStore åº”ç”¨å•†åº—
CONFIG_PACKAGE_luci-app-store=y
CONFIG_PACKAGE_luci-lib-ipkg=y

# OpenClash
CONFIG_PACKAGE_luci-app-openclash=y
CONFIG_PACKAGE_luci-app-openclash_Master=y
# OpenClash ä¾èµ–
CONFIG_PACKAGE_coreutils=y
CONFIG_PACKAGE_coreutils-nohup=y
CONFIG_PACKAGE_bash=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_iptables-mod-tproxy=y
CONFIG_PACKAGE_ipset=y

# è®¾å¤‡ä¸“ç”¨æ’ä»¶å’Œå¸¸ç”¨å·¥å…·
CONFIG_PACKAGE_luci-app-mtwifi-cfg=y
CONFIG_PACKAGE_luci-app-turboacc-mtk=y
CONFIG_PACKAGE_luci-app-upnp=y
CONFIG_PACKAGE_htop=y
CONFIG_PACKAGE_tcpdump=y
CONFIG_PACKAGE_vim-fuller=y
EOF

        echo "è‡ªå®šä¹‰é…ç½®å·²è¿½åŠ åˆ° .config"

    # æ­¥éª¤7ï¼šæ‰§è¡Œå…¨æ–°ç¼–è¯‘ï¼ˆmake cleanï¼‰
    - name: Make clean (å¼ºåˆ¶å…¨æ–°ç¼–è¯‘)
      run: |
        cd "$BUILD_DIR"
        echo "æ‰§è¡Œ make clean å¼€å§‹å…¨æ–°ç¼–è¯‘..."
        make clean
        # æ¸…ç†åé‡æ–°ç”Ÿæˆ .config æ–‡ä»¶
        if [ -f .config ]; then
          echo "é‡æ–°åº”ç”¨ .config..."
          mv .config .config.backup
          make defconfig
          # è¿™é‡Œå¯ä»¥é‡æ–°åº”ç”¨è‡ªå®šä¹‰é…ç½®ï¼Œä½†ä¸ºç®€åŒ–ï¼Œæˆ‘ä»¬ä¾èµ–ä¸Šä¸€æ­¥ç”Ÿæˆçš„æ–‡ä»¶
        fi

    # æ­¥éª¤8ï¼šç”Ÿæˆæœ€ç»ˆé…ç½®å¹¶ä¸‹è½½è½¯ä»¶åŒ…
    - name: Make defconfig and download
      run: |
        cd "$BUILD_DIR"
        make defconfig
        echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…..."
        make download -j$(nproc) || make download -j$(nproc) VERBOSE=1

    # æ­¥éª¤9ï¼šå¼€å§‹ç¼–è¯‘å›ºä»¶
    - name: Build firmware
      run: |
        cd "$BUILD_DIR"
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶ï¼Œè¿™éœ€è¦è¾ƒé•¿æ—¶é—´..."
        # ä½¿ç”¨ V=sc å‚æ•°ï¼Œåœ¨å‡ºé”™æ—¶æ˜¾ç¤ºæ›´å¤šç»†èŠ‚ï¼ŒåŒæ—¶æ§åˆ¶æ—¥å¿—è¾“å‡ºé‡
        make -j$(($(nproc)+1)) V=sc 2>&1 | tee build.log | tail -50
        # æ£€æŸ¥æœ€ç»ˆç¼–è¯‘ç»“æœ
        if ls bin/targets/$TARGET_SUBTARGET/*.bin 1>/dev/null 2>&1; then
          echo "ğŸ‰ å›ºä»¶ç¼–è¯‘æˆåŠŸ!"
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥ã€‚"
          exit 1
        fi

    # æ­¥éª¤10ï¼šä¸Šä¼ ç¼–è¯‘å¥½çš„å›ºä»¶
    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: n60pro-full-firmware
        path: ${{ env.BUILD_DIR }}/bin/targets/${{ env.TARGET_SUBTARGET }}/*.bin
        retention-days: 7

    # æ­¥éª¤11ï¼šä¸Šä¼ ç¼–è¯‘æ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    - name: Upload build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: ${{ env.BUILD_DIR }}/build.log
        retention-days: 3
