name: Build N60 Pro High Power Firmware

on:
  # æ‰‹åŠ¨è§¦å‘ç¼–è¯‘
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'æ‰§è¡Œå…¨æ–°ç¼–è¯‘ (è€—æ—¶æ›´é•¿)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      update_feeds:
        description: 'æ›´æ–°è½¯ä»¶æº'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  
  # å®šæ—¶ç¼–è¯‘ (æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹ UTCï¼ŒåŒ—äº¬æ—¶é—´11ç‚¹)
  schedule:
    - cron: '0 3 * * 0'
  
  # å½“é…ç½®æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨ç¼–è¯‘
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/**'
      - 'configs/**'
  
  # å…è®¸ä»å¤–éƒ¨ä»“åº“è§¦å‘
  repository_dispatch:
    types: [build_request]

# ç¯å¢ƒå˜é‡é…ç½®
env:
  # 237 æºç åœ°å€
  SOURCE_REPO: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  SOURCE_BRANCH: "main"
  
  # é«˜åŠŸç‡é…ç½®æ–‡ä»¶åœ°å€ (RAW æ ¼å¼)
  HIGH_POWER_CONFIG: "https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-high-power.config"
  
  # ç¼–è¯‘ç›®å½•
  BUILD_DIR: "${{ github.workspace }}/immortalwrt"
  
  # ç›®æ ‡è®¾å¤‡ (N60 Pro å¯¹åº” GL-MT6000)
  TARGET_SUBTARGET: "mediatek/mt7986"
  TARGET_PROFILE: "glinet_gl-mt6000"
  
  # ç¼–è¯‘é…ç½®
  MAKE_JOBS: "$(($(nproc) + 1))"
  CCACHE_MAX_SIZE: "2G"
  BUILD_TIMEOUT: "240"

jobs:
  prepare:
    name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    outputs:
      cache_key: ${{ steps.cache-key.outputs.key }}
    
    steps:
    - name: ç”Ÿæˆç¼“å­˜é”®
      id: cache-key
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M)
        echo "key=mt7986-n60pro-$TIMESTAMP-${{ github.sha }}" >> $GITHUB_OUTPUT
        
    - name: é…ç½®å·¥ä½œç©ºé—´
      run: |
        echo "å·¥ä½œç›®å½•: ${{ github.workspace }}"
        echo "ç¼–è¯‘ç›®å½•: $BUILD_DIR"
        mkdir -p ${{ github.workspace }}/artifacts

  setup:
    name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
    needs: prepare
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    steps:
    - name: æ£€å‡ºå·¥ä½œæµä»“åº“
      uses: actions/checkout@v4
      with:
        path: workflow-repo

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-pip \
          python3-setuptools \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          curl \
          jq \
          xxd \
          time \
          subversion \
          mercurial \
          gperf \
          zip \
          help2man \
          texinfo \
          libtool \
          libtool-bin \
          autoconf \
          automake \
          pkg-config \
          libc6-dev \
          libgmp-dev \
          libmpc-dev \
          libmpfr-dev

    - name: è®¾ç½® ccache
      uses: hendrikmuhs/ccache-action@v1.3
      with:
        key: ${{ needs.prepare.outputs.cache_key }}
        max-size: ${{ env.CCACHE_MAX_SIZE }}
        save: true

    - name: å…‹éš† 237 æºç 
      run: |
        echo "æ­£åœ¨å…‹éš† 237 æºç ..."
        git clone --depth 1 --branch "$SOURCE_BRANCH" "$SOURCE_REPO" "$BUILD_DIR"
        cd "$BUILD_DIR"
        echo "æºç ç‰ˆæœ¬: $(git log -1 --oneline)"

    - name: ä¸‹è½½é«˜åŠŸç‡é…ç½®æ–‡ä»¶
      run: |
        echo "æ­£åœ¨ä¸‹è½½é«˜åŠŸç‡é…ç½®æ–‡ä»¶..."
        cd "$BUILD_DIR"
        
        # ä¸‹è½½é«˜åŠŸç‡é…ç½®æ–‡ä»¶
        curl -L -o .config "$HIGH_POWER_CONFIG"
        
        # éªŒè¯é…ç½®æ–‡ä»¶
        if [ -f ".config" ]; then
          echo "âœ… é…ç½®æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
          echo "æ–‡ä»¶å¤§å°: $(wc -l < .config) è¡Œ"
          echo "å‰10è¡Œé…ç½®:"
          head -10 .config
        else
          echo "âŒ é…ç½®æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: é…ç½® N60 Pro ä¸“ç”¨è®¾ç½®
      run: |
        cd "$BUILD_DIR"
        
        echo "æ­£åœ¨é…ç½® N60 Pro ä¸“ç”¨è®¾ç½®..."
        
        # ç¡®ä¿åªç¼–è¯‘ GL-MT6000 (N60 Pro)
        sed -i '/CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_/d' .config
        
        # å¯ç”¨ GL-MT6000
        echo "CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_glinet_gl-mt6000=y" >> .config
        
        # ç¦ç”¨å…¶ä»–è®¾å¤‡
        echo "# CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_tplink_tl-xdr6086 is not set" >> .config
        echo "# CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_tplink_tl-xdr6088 is not set" >> .config
        echo "# CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_xiaomi_redmi-router-ax6000 is not set" >> .config
        echo "# CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_xiaomi_redmi-router-ax6000-stock is not set" >> .config
        
        # ç¦ç”¨å¤šè®¾å¤‡ç¼–è¯‘
        sed -i 's/CONFIG_TARGET_MULTI_PROFILE=y/# CONFIG_TARGET_MULTI_PROFILE is not set/' .config
        
        echo "âœ… N60 Pro é…ç½®å®Œæˆ"

    - name: æ›´æ–°è½¯ä»¶æº
      if: github.event.inputs.update_feeds != 'false'
      run: |
        cd "$BUILD_DIR"
        echo "æ­£åœ¨æ›´æ–°è½¯ä»¶æº..."
        
        # æ›´æ–° feeds
        ./scripts/feeds update -a
        
        # å®‰è£…æ‰€æœ‰åŒ…
        ./scripts/feeds install -a
        
        echo "âœ… è½¯ä»¶æºæ›´æ–°å®Œæˆ"

    - name: ä¿å­˜ç¼–è¯‘ç¯å¢ƒ
      uses: actions/upload-artifact@v4
      with:
        name: prepared-source
        path: ${{ env.BUILD_DIR }}
        retention-days: 1

  compile:
    name: ç¼–è¯‘å›ºä»¶
    needs: [prepare, setup]
    runs-on: ubuntu-22.04
    timeout-minutes: ${{ env.BUILD_TIMEOUT }}
    
    steps:
    - name: æ¢å¤ ccache
      uses: hendrikmuhs/ccache-action@v1.3
      with:
        key: ${{ needs.prepare.outputs.cache_key }}
        max-size: ${{ env.CCACHE_MAX_SIZE }}
        restore: true

    - name: æ¢å¤æºç 
      uses: actions/download-artifact@v4
      with:
        name: prepared-source
        path: ${{ github.workspace }}

    - name: ç”Ÿæˆé»˜è®¤é…ç½®
      run: |
        cd "$BUILD_DIR"
        echo "æ­£åœ¨ç”Ÿæˆé»˜è®¤é…ç½®..."
        make defconfig
        
        # æ˜¾ç¤ºé…ç½®å·®å¼‚
        echo "=== é…ç½®å·®å¼‚ ==="
        ./scripts/diffconfig.sh

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd "$BUILD_DIR"
        echo "æ­£åœ¨ä¸‹è½½è½¯ä»¶åŒ…..."
        
        # å°è¯•å¹¶è¡Œä¸‹è½½ï¼Œå¤±è´¥åé‡è¯•
        make download -j$(nproc) || {
          echo "å¹¶è¡Œä¸‹è½½å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ä¸‹è½½..."
          make download -j1
        }
        
        # æ¸…ç†æŸåçš„å°æ–‡ä»¶
        find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true
        
        echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd "$BUILD_DIR"
        
        # è®°å½•å¼€å§‹æ—¶é—´
        START_TIME=$(date +%s)
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        
        # åˆ¤æ–­æ˜¯å¦æ‰§è¡Œå…¨æ–°ç¼–è¯‘
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "ğŸ§¹ æ‰§è¡Œå…¨æ–°ç¼–è¯‘..."
          make clean
          make download -j$(nproc)
        fi
        
        echo "ğŸš€ å¼€å§‹ç¼–è¯‘ N60 Pro é«˜åŠŸç‡å›ºä»¶..."
        echo "ä½¿ç”¨çº¿ç¨‹æ•°: $MAKE_JOBS"
        
        # ç¼–è¯‘å›ºä»¶ (V=s æ˜¾ç¤ºè¯¦ç»†è¾“å‡º)
        make -j$MAKE_JOBS V=s 2>&1 | tee build.log
        
        # è®°å½•ç»“æŸæ—¶é—´
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        echo "========================================"
        echo "âœ… ç¼–è¯‘å®Œæˆ!"
        echo "æ€»è€—æ—¶: $(($DURATION / 60))åˆ†é’Ÿ $(($DURATION % 60))ç§’"
        echo "å®Œæˆæ—¶é—´: $(date)"
        echo "========================================"

    - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
      run: |
        cd "$BUILD_DIR"
        
        echo "æ£€æŸ¥ç¼–è¯‘ç»“æœ..."
        
        # æ£€æŸ¥å›ºä»¶æ–‡ä»¶
        if ls bin/targets/$TARGET_SUBTARGET/*.bin 1> /dev/null 2>&1; then
          echo "âœ… å›ºä»¶æ–‡ä»¶ç”ŸæˆæˆåŠŸ!"
          echo "ç”Ÿæˆçš„å›ºä»¶:"
          ls -la bin/targets/$TARGET_SUBTARGET/*.bin
        else
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶!"
          echo "ç›®å½•å†…å®¹:"
          ls -la bin/targets/$TARGET_SUBTARGET/ || true
          exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: n60pro-highpower-firmware
        path: |
          ${{ env.BUILD_DIR }}/bin/targets/${{ env.TARGET_SUBTARGET }}/*.bin
          ${{ env.BUILD_DIR }}/bin/targets/${{ env.TARGET_SUBTARGET }}/*.manifest
        retention-days: 30
        if-no-files-found: error

    - name: ä¸Šä¼ è½¯ä»¶åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: n60pro-packages
        path: |
          ${{ env.BUILD_DIR }}/bin/targets/${{ env.TARGET_SUBTARGET }}/packages/*
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ${{ env.BUILD_DIR }}/build.log
          ${{ env.BUILD_DIR }}/.config
          ${{ env.BUILD_DIR }}/config.buildinfo
        retention-days: 7

    - name: åˆ›å»º GitHub Release
      if: success() && github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        name: "N60 Pro é«˜åŠŸç‡å›ºä»¶ v${{ github.run_number }}"
        tag_name: "n60pro-highpower-${{ github.run_number }}"
        body: |
          # N60 Pro é«˜åŠŸç‡å›ºä»¶
          
          ## å›ºä»¶ä¿¡æ¯
          - **ç¼–è¯‘æ—¶é—´**: ${{ fromJSON('{"date": "'$(date)'"}').date }}
          - **æºç ç‰ˆæœ¬**: 237's immortalwrt-mt798x-24.10
          - **é…ç½®æ–‡ä»¶**: nx60pro-ipailna-high-power.config
          - **ç¼–è¯‘ç¼–å·**: ${{ github.run_number }}
          
          ## è®¾å¤‡ä¿¡æ¯
          - **å‹å·**: GL.iNet GL-MT6000 (N60 Pro)
          - **èŠ¯ç‰‡**: MediaTek MT7986
          - **æ— çº¿**: MT7976 (iPaiLNA é«˜åŠŸç‡)
          
          ## åˆ·æœºè¯´æ˜
          1. è¿›å…¥è·¯ç”±å™¨åå°
          2. é€‰æ‹©ç³»ç»Ÿå‡çº§
          3. ä¸Šä¼ æœ¬å›ºä»¶
          4. ä¿ç•™é…ç½®(å¯é€‰)
          5. å¼€å§‹åˆ·æœº
          
          âš ï¸ **æ³¨æ„**: åˆ·æœºæœ‰é£é™©ï¼Œè¯·ç¡®ä¿è®¾å¤‡å‹å·æ­£ç¡®ï¼
          
          ## æ›´æ–°æ—¥å¿—
          - ä½¿ç”¨ 237 æœ€æ–°æºç ç¼–è¯‘
          - å¯ç”¨ iPaiLNA é«˜åŠŸç‡é©±åŠ¨
          - ä¼˜åŒ–æ— çº¿æ€§èƒ½
        draft: false
        prerelease: false
        files: ${{ env.BUILD_DIR }}/bin/targets/${{ env.TARGET_SUBTARGET }}/*.bin

  notify:
    name: é€šçŸ¥ç»“æœ
    needs: compile
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ç¼–è¯‘ç»“æœé€šçŸ¥
      run: |
        echo "ç¼–è¯‘ä½œä¸šçŠ¶æ€: ${{ needs.compile.result }}"
        
        if [ "${{ needs.compile.result }}" = "success" ]; then
          echo "ğŸ‰ N60 Pro é«˜åŠŸç‡å›ºä»¶ç¼–è¯‘æˆåŠŸ!"
          echo "å›ºä»¶å·²ä¸Šä¼ åˆ° Artifacts"
        else
          echo "âŒ N60 Pro é«˜åŠŸç‡å›ºä»¶ç¼–è¯‘å¤±è´¥!"
          echo "è¯·æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—æ’æŸ¥é—®é¢˜"
        fi
