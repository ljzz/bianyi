name: N60 Pro One-Time Build

# 关键配置：只在推送时运行一次
on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/n60pro-onetime-build.yml'

# 或者使用 repository_dispatch 触发一次
# on:
#   repository_dispatch:
#     types: [one_time_build]

env:
  SOURCE_REPO: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  SOURCE_BRANCH: "main"
  HIGH_POWER_CONFIG: "https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-high-power.config"
  BUILD_DIR: "${{ github.workspace }}/immortalwrt"
  TARGET_SUBTARGET: "mediatek/mt7986"
  TARGET_PROFILE: "glinet_gl-mt6000"

jobs:
  build:
    name: 编译 N60 Pro 高功率固件
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # 3小时超时
    
    steps:
    - name: 检查代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache clang flex bison g++ gawk \
          gcc-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev \
          file wget curl jq

    - name: 克隆源码
      run: |
        echo "正在克隆 237 源码..."
        git clone --depth 1 --branch "$SOURCE_BRANCH" "$SOURCE_REPO" "$BUILD_DIR"

    - name: 应用高功率配置
      run: |
        cd "$BUILD_DIR"
        echo "下载高功率配置..."
        curl -L -o .config "$HIGH_POWER_CONFIG"
        
        # 只编译 N60 Pro (GL-MT6000)
        sed -i '/CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_/d' .config
        echo "CONFIG_TARGET_DEVICE_mediatek_mt7986_DEVICE_glinet_gl-mt6000=y" >> .config
        sed -i 's/CONFIG_TARGET_MULTI_PROFILE=y/# CONFIG_TARGET_MULTI_PROFILE is not set/' .config

    - name: 准备编译环境
      run: |
        cd "$BUILD_DIR"
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig
        make download -j$(nproc)

    - name: 编译固件
      run: |
        cd "$BUILD_DIR"
        echo "开始编译..."
        make -j$(nproc) V=s

    - name: 上传固件
      uses: actions/upload-artifact@v4
      with:
        name: n60pro-firmware
        path: |
          ${{ env.BUILD_DIR }}/bin/targets/${{ env.TARGET_SUBTARGET }}/*.bin
        retention-days: 30
