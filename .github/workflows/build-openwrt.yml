name: ç¼–è¯‘ N60 PRO é«˜åŠŸç‡å›ºä»¶

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'æ‰§è¡Œå®Œæ•´æ¸…ç†ç¼–è¯‘ï¼ˆè€—æ—¶æ›´é•¿ï¼‰'
        required: false
        default: 'false'
        type: string

env:
  SOURCE_URL: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  CONFIG_REPO: "https://github.com/padavanonly/immortalwrt-mt798x-6.6"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 200

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-pip rsync unzip zlib1g-dev file wget curl

    - name: å…‹éš† ImmortalWrt æºç 
      run: |
        echo "æ­£åœ¨å…‹éš†æºç ä»“åº“..."
        git clone --depth 1 --branch main $SOURCE_URL openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åˆ›å»ºé«˜åŠŸç‡é…ç½®æ–‡ä»¶
      run: |
        cd openwrt
        echo "åˆ›å»ºé«˜åŠŸç‡é…ç½®æ–‡ä»¶..."
        
        # ç›´æ¥åˆ›å»º .config æ–‡ä»¶ï¼Œé¿å…ä¸‹è½½é—®é¢˜
        cat > .config << 'EOF'
CONFIG_TARGET_MEDIATEK=y
CONFIG_TARGET_MEDIATEK_FILOGIC=y
CONFIG_TARGET_MEDIATEK_FILOGIC_DEVICE_CMCC_N60_PRO=y
CONFIG_TARGET_PROFILE="CMCC N60 PRO"
CONFIG_TARGET_ROOTFS_PARTSIZE=512
CONFIG_TARGET_ROOTFS_TARGZ=n
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_KERNEL_KALLSYMS=n
CONFIG_KERNEL_DEBUG_INFO=n
CONFIG_KERNEL_DEBUG_KERNEL=n
CONFIG_KERNEL_PERF_EVENTS=n
CONFIG_KERNEL_PROFILING=n
EOF
        
        echo "âœ… é«˜åŠŸç‡é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"

    - name: é…ç½®è½¯ä»¶åŒ…
      run: |
        cd openwrt
        echo "é…ç½®è½¯ä»¶åŒ…..."
        
        # ä½¿ç”¨ echo é€è¡Œæ·»åŠ é…ç½®ï¼Œé¿å…æ ¼å¼é—®é¢˜
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-istore=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-istore-zh-cn=y" >> .config
        
        # OpenClash ä¾èµ–
        echo "CONFIG_PACKAGE_bash=y" >> .config
        echo "CONFIG_PACKAGE_coreutils=y" >> .config
        echo "CONFIG_PACKAGE_coreutils-nohup=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        echo "CONFIG_PACKAGE_ip-full=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-tproxy=y" >> .config
        echo "CONFIG_PACKAGE_iptables-mod-extra=y" >> .config
        echo "CONFIG_PACKAGE_luci-compat=y" >> .config
        
        # ç§»é™¤ä¸éœ€è¦çš„åŒ…
        echo "CONFIG_PACKAGE_luci-app-adblock=n" >> .config
        echo "CONFIG_PACKAGE_luci-app-docker=n" >> .config
        echo "CONFIG_PACKAGE_docker=n" >> .config
        echo "CONFIG_PACKAGE_dockerd=n" >> .config
        
        # åº”ç”¨é…ç½®
        make defconfig
        echo "âœ… è½¯ä»¶åŒ…é…ç½®å®Œæˆ"

    - name: åˆ›å»ºç½‘ç»œé…ç½®æ–‡ä»¶
      run: |
        echo "åˆ›å»ºç½‘ç»œé…ç½®æ–‡ä»¶..."
        mkdir -p openwrt/files/etc/uci-defaults
        
        # ä½¿ç”¨Base64ç¼–ç é¿å…YAMLè§£æé—®é¢˜
        echo IyEvYmluL3NoCiMg5a6e5pS255qE5Yid5aeR5YyW6K6/6ZeuCiMgTEFOIOiuv+e9rgp1Y2kgc2V0IG5ldHdvcmsubGFuLmlwYWRkcj0nMTkyLjE2OC42LjEnCnVjaSBzZXQgbmV0d29yay5sYW4ubmV0bWFzaz0nMjU1LjI1NS4yNTUuMCcKCiMgUFBQb0Ug6L+r6L2v6K6/6ZeuCnVjaSBkZWxldGUgbmV0d29yay53YW4gMj4vZGV2L251bGwgfHwgdHJ1ZQp1Y2kgc2V0IG5ldHdvcmsud2FuPWludGVyZmFjZQp1Y2kgc2V0IG5ldHdvcmsud2FuLnByb3RvPSdwcHBvZScKdWNpIHNldCBuZXR3b3JrLndhbi51c2VybmFtZT0nMTU4Mjg4NjA5NzAnCnVjaSBzZXQgbmV0d29yay53YW4ucGFzc3dvcmQ9JzE0NzI1OCcKdWNpIHNldCBuZXR3b3JrLndhbi5pcHY2PSdhdXRvJwoKIyBJUHY2IOiuv+e9rgp1Y2kgc2V0IGRoY3AubGFuLmRoY3B2Nj0nc2VydmVyJwp1Y2kgc2V0IGRoY3AubGFuLnJhPSdzZXJ2ZXInCnVjaSBzZXQgZGhjcC5sYW4ucmFfbWFuYWdlbWVudD0nMScKCiMgMi40R0h6IFdpRmkg6K6/6ZeuCnVjaSBzZXQgd2lyZWxlc3MucmFkaW8wLmNoYW5uZWw9J2F1dG8nCnVjaSBzZXQgd2lyZWxlc3MucmFkaW8wLmh0bW9kZT0nSEU0MCcKdWNpIHNldCB3aXJlbGVzcy5kZWZhdWx0X3JhZGlvMC5zc2lkPSdsb2N1c3QnCnVjaSBzZXQgd2lyZWxlc3MuZGVmYXVsdF9yYWRpbzAua2V5PSczNjkyNTg4OCcKdWNpIHNldCB3aXJlbGVzcy5kZWZhdWx0X3JhZGlvMC5lbmNyeXB0aW9uPSdwc2syJwoKIyA1R0h6IFdpRmkg6K6/6ZeuCnVjaSBzZXQgd2lyZWxlc3MucmFkaW8xLmNoYW5uZWw9J2F1dG8nCnVjaSBzZXQgd2lyZWxlc3MucmFkaW8xLmh0bW9kZT0nSEUxNjAnCnVjaSBzZXQgd2lyZWxlc3MuZGVmYXVsdF9yYWRpbzEuc3NpZD0nbG9jdXN0LTVHJwp1Y2kgc2V0IHdpcmVsZXNzLmRlZmF1bHRfcmFkaW8xLmtleT0nMzY5MjU4ODgnCnVjaSBzZXQgd2lyZWxlc3MuZGVmYXVsdF9yYWRpbzEuZW5jcnlwdGlvbj0ncHNrMicKCiMg5L+d5a2Y5YWo6K6vdWNpIGNvbW1pdCBuZXR3b3JrCnVjaSBjb21taXQgd2lyZWxlc3MKdWNpIGNvbW1pdCBkaGNwCgpleGl0IDAK | base64 -d > openwrt/files/etc/uci-defaults/99-custom
        
        chmod +x openwrt/files/etc/uci-defaults/99-custom
        echo "âœ… ç½‘ç»œé…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"

    - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–
      run: |
        cd openwrt
        echo "ä¸‹è½½ä¾èµ–åŒ…..."
        make download -j$(nproc) || make download -j4 || make download -j1
        echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç†ç¼–è¯‘
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "æ‰§è¡Œå®Œæ•´æ¸…ç†ç¼–è¯‘..."
          make clean
          make dirclean
        fi
        
        # æ£€æŸ¥.configæ–‡ä»¶æ ¼å¼
        echo "æ£€æŸ¥.configæ–‡ä»¶æ ¼å¼..."
        if grep -n "^[[:space:]]" .config; then
          echo "âš ï¸  å‘ç°è¡Œé¦–ç©ºç™½ï¼Œæ­£åœ¨æ¸…ç†..."
          sed -i 's/^[[:space:]]*//' .config
        fi
        
        # å¼€å§‹ç¼–è¯‘ï¼Œé€æ­¥é™çº§
        echo "ç¼–è¯‘æ­¥éª¤1: å°è¯•å¹¶è¡Œç¼–è¯‘..."
        if make -j$(nproc); then
          echo "âœ… å¹¶è¡Œç¼–è¯‘æˆåŠŸ"
        else
          echo "ç¼–è¯‘æ­¥éª¤2: é™çº§åˆ°ä¸€åŠæ ¸å¿ƒ..."
          if make -j$(($(nproc)/2)); then
            echo "âœ… é™çº§ç¼–è¯‘æˆåŠŸ"
          else
            echo "ç¼–è¯‘æ­¥éª¤3: å•çº¿ç¨‹è¯¦ç»†è¾“å‡º..."
            make -j1 V=s
          fi
        fi
        
        echo "ç¼–è¯‘å®Œæˆï¼"

    - name: æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
      id: find-firmware
      run: |
        cd openwrt
        echo "æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶..."
        
        # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        FIRMWARE_PATH=$(find bin/targets -name "*cmcc_n60pro*sysupgrade.bin" -type f 2>/dev/null | head -1)
        
        if [ -z "$FIRMWARE_PATH" ]; then
          echo "å°è¯•å…¶ä»–åç§°æŸ¥æ‰¾..."
          FIRMWARE_PATH=$(find bin/targets -name "*n60pro*.bin" -type f 2>/dev/null | head -1)
        fi
        
        if [ -z "$FIRMWARE_PATH" ]; then
          echo "åˆ—å‡ºæ‰€æœ‰å›ºä»¶æ–‡ä»¶:"
          find bin/targets -name "*.bin" -type f 2>/dev/null | head -10
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          exit 1
        fi
        
        echo "æ‰¾åˆ°å›ºä»¶ï¼š$FIRMWARE_PATH"
        
        # é‡å‘½åå›ºä»¶
        FIRMWARE_NAME="immortalwrt-n60pro-highpower-$(date +%Y%m%d-%H%M).bin"
        cp "$FIRMWARE_PATH" "/tmp/$FIRMWARE_NAME"
        
        # è¾“å‡ºå˜é‡
        echo "firmware_name=$FIRMWARE_NAME" >> $GITHUB_OUTPUT
        echo "firmware_path=/tmp/$FIRMWARE_NAME" >> $GITHUB_OUTPUT
        echo "âœ… å›ºä»¶å‡†å¤‡å®Œæˆ"

    - name: ä¸Šä¼ å›ºä»¶åˆ°ä»“åº“
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ä¸Šä¼ å›ºä»¶åˆ° ljzz/bianyi ä»“åº“..."
        
        # å…‹éš†ç›®æ ‡ä»“åº“
        git clone https://x-access-token:$GITHUB_TOKEN@github.com/ljzz/bianyi.git firmware-repo
        cd firmware-repo
        
        # åˆ›å»ºæˆ–æ¸…ç©º firmware ç›®å½•
        mkdir -p firmware
        rm -rf firmware/*
        
        # å¤åˆ¶å›ºä»¶æ–‡ä»¶
        cp /tmp/immortalwrt-n60pro-highpower-*.bin firmware/ 2>/dev/null || true
        
        # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
        cd firmware
        for f in *.bin; do
          if [ -f "$f" ]; then
            md5sum "$f" > "$f.md5"
            sha256sum "$f" > "$f.sha256"
          fi
        done
        
        # åˆ›å»º README
        cat > README.md << 'EOF'
# N60 PRO é«˜åŠŸç‡å›ºä»¶

## å›ºä»¶ä¿¡æ¯
- **è®¾å¤‡**: CMCC N60 PRO
- **æºç **: ImmortalWrt 24.10
- **é…ç½®**: é«˜åŠŸç‡ç‰ˆæœ¬
- **ç¼–è¯‘æ—¶é—´**: $(date)

## åŒ…å«åŠŸèƒ½
- Argon ä¸»é¢˜
- OpenClash
- iStore
- PPPoE é¢„é…ç½®
- IPv6 è‡ªåŠ¨å¯ç”¨

## é»˜è®¤é…ç½®
- ç®¡ç†åœ°å€: 192.168.6.1
- WiFi 2.4G: locust (å¯†ç : 36925888)
- WiFi 5G: locust-5G (å¯†ç : 36925888)
- PPPoEè´¦å·: 15828860970
- PPPoEå¯†ç : 147258

## åˆ·æœºè¯´æ˜
1. ä¸‹è½½æœ€æ–°çš„ `.bin` æ–‡ä»¶
2. è®¿é—®è·¯ç”±å™¨åŸå‚ç®¡ç†ç•Œé¢
3. è¿›å…¥"ç³»ç»Ÿå‡çº§"é¡µé¢
4. ä¸Šä¼ å›ºä»¶æ–‡ä»¶
5. ç­‰å¾…é‡å¯å®Œæˆï¼ˆçº¦3-5åˆ†é’Ÿï¼‰
6. è®¿é—® http://192.168.6.1

## æ³¨æ„äº‹é¡¹
- ä»…é€‚ç”¨äº CMCC N60 PRO è·¯ç”±å™¨
- åˆ·æœºåè¯·ç«‹å³ä¿®æ”¹å¯†ç 
- é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´åˆå§‹åŒ–
EOF
        
        # åˆ—å‡ºæ–‡ä»¶
        echo "" >> README.md
        echo "## æ–‡ä»¶åˆ—è¡¨" >> README.md
        echo "\`\`\`" >> README.md
        ls -lh *.bin 2>/dev/null | head -10 >> README.md || echo "æš‚æ— å›ºä»¶æ–‡ä»¶" >> README.md
        echo "\`\`\`" >> README.md
        
        # æäº¤æ›´æ”¹
        cd ..
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        git add firmware/
        git commit -m "æ›´æ–°å›ºä»¶: $(date +%Y%m%d-%H%M%S)"
        
        # å°è¯•æ¨é€
        git push origin main || echo "æ¨é€å¤±è´¥æˆ–æ²¡æœ‰æ›´æ”¹"
        
        echo "âœ… å›ºä»¶å·²ä¸Šä¼ åˆ°: https://github.com/ljzz/bianyi/tree/main/firmware"
        if [ -f "firmware/${{ steps.find-firmware.outputs.firmware_name }}" ]; then
          echo "ğŸ“¥ ç›´æ¥ä¸‹è½½: https://github.com/ljzz/bianyi/raw/main/firmware/${{ steps.find-firmware.outputs.firmware_name }}"
        fi

    - name: ç¼–è¯‘å®Œæˆé€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸï¼"
          echo "å›ºä»¶å·²ä¸Šä¼ åˆ°ä½ çš„ä»“åº“"
          echo "è®¿é—®: https://github.com/ljzz/bianyi/tree/main/firmware"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          echo "è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯"
        fi
