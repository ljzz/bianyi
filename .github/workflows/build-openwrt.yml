name: ç¼–è¯‘ N60 PRO å›ºä»¶

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'æ¸…ç†ç¼–è¯‘ï¼ˆæ¨èä¿æŒé»˜è®¤ falseï¼‰'
        required: false
        default: false
        type: boolean

env:
  REPO_URL: "https://github.com/ljzz/bianyi.git"
  SOURCE_URL: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  HIGH_POWER_CONFIG: "https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-highpower.config"

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: æ£€æŸ¥æºç ä»“åº“
      uses: actions/checkout@v4
      with:
        path: source-repo

    - name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget curl

    - name: å…‹éš† ImmortalWrt æºç 
      run: |
        echo "æ­£åœ¨å…‹éš† ImmortalWrt æºç ..."
        git clone --depth 1 --branch main $SOURCE_URL openwrt-build
        cd openwrt-build
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åº”ç”¨é«˜åŠŸç‡é…ç½®
      run: |
        cd openwrt-build
        echo "ä¸‹è½½é«˜åŠŸç‡é…ç½®æ–‡ä»¶..."
        wget -q -O .config "$HIGH_POWER_CONFIG"
        
        # ç¡®ä¿é€‰æ‹©æ­£ç¡®çš„è®¾å¤‡
        echo "CONFIG_TARGET_MEDIATEK_FILOGIC=y" >> .config
        echo "CONFIG_TARGET_MEDIATEK_FILOGIC_DEVICE_CMCC_N60_PRO=y" >> .config
        
        echo "åº”ç”¨åŸºç¡€é…ç½®..."
        make defconfig

    - name: é…ç½®è½¯ä»¶åŒ…
      run: |
        cd openwrt-build
        echo "é…ç½®è½¯ä»¶åŒ…..."
        
        # æ·»åŠ å¿…è¦è½¯ä»¶åŒ…
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-istore=y" >> .config
        
        # OpenClash ä¾èµ–
        echo "CONFIG_PACKAGE_bash=y" >> .config
        echo "CONFIG_PACKAGE_coreutils-nohup=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        
        # ç§»é™¤ä¸éœ€è¦çš„è½¯ä»¶åŒ…
        echo "CONFIG_PACKAGE_luci-app-adblock=n" >> .config
        echo "CONFIG_PACKAGE_luci-app-docker=n" >> .config
        
        # æ›´æ–°é…ç½®
        make defconfig

    - name: åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶
      run: |
        echo "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
        mkdir -p openwrt-build/files/etc/uci-defaults
        
        cat > openwrt-build/files/etc/uci-defaults/99-custom << 'EOF'
#!/bin/sh

# LAN è®¾ç½®
uci set network.lan.ipaddr='192.168.6.1'
uci set network.lan.netmask='255.255.255.0'

# PPPoE è®¾ç½®
uci delete network.wan 2>/dev/null || true
uci set network.wan=interface
uci set network.wan.proto='pppoe'
uci set network.wan.username='15828860970'
uci set network.wan.password='147258'
uci set network.wan.ipv6='auto'

# IPv6 è®¾ç½®
uci set dhcp.lan.dhcpv6='server'
uci set dhcp.lan.ra='server'

# WiFi 2.4G
uci set wireless.default_radio0.ssid='locust'
uci set wireless.default_radio0.key='36925888'
uci set wireless.default_radio0.encryption='psk2'

# WiFi 5G
uci set wireless.default_radio1.ssid='locust-5G'
uci set wireless.default_radio1.key='36925888'
uci set wireless.default_radio1.encryption='psk2'

uci commit
exit 0
EOF
        
        chmod +x openwrt-build/files/etc/uci-defaults/99-custom

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd openwrt-build
        echo "ä¸‹è½½ä¾èµ–åŒ…..."
        make download -j$(nproc) || make download -j1

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt-build
        
        if ${{ github.event.inputs.clean_build }}; then
          echo "æ‰§è¡Œæ¸…ç†ç¼–è¯‘..."
          make clean
        fi
        
        echo "å¼€å§‹ç¼–è¯‘..."
        # å°è¯•å¹¶è¡Œç¼–è¯‘
        make -j$(nproc) || make -j1 V=s
        
        echo "ç¼–è¯‘å®Œæˆï¼æŸ¥æ‰¾å›ºä»¶..."
        find . -name "*.bin" -type f | grep -i "n60pro\|cmcc" | head -10

    - name: å‡†å¤‡å›ºä»¶æ–‡ä»¶
      id: prepare-firmware
      run: |
        echo "å‡†å¤‡å›ºä»¶æ–‡ä»¶..."
        
        # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        cd openwrt-build
        
        # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶ï¼ˆå°è¯•å¤šç§å¯èƒ½è·¯å¾„ï¼‰
        FIRMWARE_PATH=$(find bin/targets/mediatek/filogic -name "*cmcc_n60pro*sysupgrade.bin" -type f 2>/dev/null | head -1)
        
        if [ -z "$FIRMWARE_PATH" ]; then
          echo "å°è¯•å…¶ä»–è·¯å¾„æŸ¥æ‰¾..."
          FIRMWARE_PATH=$(find . -name "*n60pro*.bin" -type f | head -1)
        fi
        
        if [ -z "$FIRMWARE_PATH" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼"
          echo "å½“å‰ç›®å½•ç»“æ„ï¼š"
          find bin/targets/ -name "*.bin" -type f 2>/dev/null | head -20
          exit 1
        fi
        
        echo "æ‰¾åˆ°å›ºä»¶ï¼š$FIRMWARE_PATH"
        
        # é‡å‘½åå›ºä»¶
        FIRMWARE_NAME="immortalwrt-n60pro-highpower-$(date +%Y%m%d-%H%M).bin"
        cp "$FIRMWARE_PATH" "/tmp/$FIRMWARE_NAME"
        
        # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
        cd /tmp
        md5sum "$FIRMWARE_NAME" > "$FIRMWARE_NAME.md5"
        sha256sum "$FIRMWARE_NAME" > "$FIRMWARE_NAME.sha256"
        
        # åˆ›å»ºå›ºä»¶ä¿¡æ¯æ–‡ä»¶
        cat > firmware-info.txt << EOF
è®¾å¤‡å‹å·ï¼šCMCC N60 PRO
å›ºä»¶åç§°ï¼š$FIRMWARE_NAME
ç¼–è¯‘æ—¶é—´ï¼š$(date)
æºç ç‰ˆæœ¬ï¼šImmortalWrt 24.10
é…ç½®ç±»å‹ï¼šé«˜åŠŸç‡ç‰ˆæœ¬

åŒ…å«åŠŸèƒ½ï¼š
- Argon ä¸»é¢˜
- OpenClash
- iStore
- PPPoE æ‹¨å·é¢„é…ç½®
- IPv6 è‡ªåŠ¨å¯ç”¨

é»˜è®¤é…ç½®ï¼š
- ç®¡ç†åœ°å€ï¼š192.168.6.1
- WiFi 2.4Gï¼šlocust
- WiFi 5Gï¼šlocust-5G
- WiFi å¯†ç ï¼š36925888
- PPPoEè´¦å·ï¼š15828860970
- PPPoEå¯†ç ï¼š147258

åˆ·æœºè¯´æ˜ï¼š
1. åœ¨åŸå‚ç³»ç»Ÿé€‰æ‹©"ç³»ç»Ÿå‡çº§"
2. ä¸Šä¼ æœ¬å›ºä»¶æ–‡ä»¶
3. ç­‰å¾…é‡å¯å®Œæˆï¼ˆ3-5åˆ†é’Ÿï¼‰
4. è®¿é—® http://192.168.6.1

æ³¨æ„ï¼šä»…é€‚ç”¨äº CMCC N60 PRO è·¯ç”±å™¨
EOF
        
        echo "å›ºä»¶å¤§å°ï¼š$(du -h /tmp/$FIRMWARE_NAME | cut -f1)"
        echo "å›ºä»¶MD5ï¼š$(md5sum /tmp/$FIRMWARE_NAME | cut -d' ' -f1)"
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "firmware_name=$FIRMWARE_NAME" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°ä»“åº“
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ä¸Šä¼ å›ºä»¶åˆ° ljzz/bianyi ä»“åº“..."
        
        # å…‹éš†ç›®æ ‡ä»“åº“
        git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/ljzz/bianyi.git firmware-repo
        cd firmware-repo
        
        # åˆ›å»ºæˆ–æ¸…ç©º firmware ç›®å½•
        mkdir -p firmware
        rm -rf firmware/*
        
        # å¤åˆ¶å›ºä»¶æ–‡ä»¶
        cp /tmp/immortalwrt-n60pro-highpower-*.bin firmware/
        cp /tmp/*.md5 firmware/ 2>/dev/null || true
        cp /tmp/*.sha256 firmware/ 2>/dev/null || true
        cp /tmp/firmware-info.txt firmware/
        
        # åˆ›å»º README
        cat > firmware/README.md << 'EOF'
# N60 PRO å›ºä»¶ä»“åº“

è¿™æ˜¯ä¸º CMCC N60 PRO è·¯ç”±å™¨ç¼–è¯‘çš„ ImmortalWrt é«˜åŠŸç‡å›ºä»¶ã€‚

## æœ€æ–°å›ºä»¶
- **æ–‡ä»¶**ï¼š`immortalwrt-n60pro-highpower-YYYYMMDD-HHMM.bin`
- **ç¼–è¯‘æ—¶é—´**ï¼šæ¯æ¬¡æ‰‹åŠ¨è§¦å‘ç¼–è¯‘æ—¶æ›´æ–°
- **åŒ…å«æ’ä»¶**ï¼šArgon ä¸»é¢˜ã€OpenClashã€iStore
- **é»˜è®¤é…ç½®**ï¼šå·²é¢„é…ç½® PPPoEã€WiFiã€ç®¡ç†åœ°å€

## æ–‡ä»¶è¯´æ˜
- `*.bin` - å›ºä»¶åˆ·æœºæ–‡ä»¶
- `*.md5` - MD5 æ ¡éªŒæ–‡ä»¶
- `*.sha256` - SHA256 æ ¡éªŒæ–‡ä»¶
- `firmware-info.txt` - è¯¦ç»†å›ºä»¶ä¿¡æ¯

## åˆ·æœºæ­¥éª¤
1. ä¸‹è½½æœ€æ–°çš„ `.bin` æ–‡ä»¶
2. ç™»å½•è·¯ç”±å™¨åŸå‚ç®¡ç†ç•Œé¢
3. è¿›å…¥"ç³»ç»Ÿå‡çº§"é¡µé¢
4. é€‰æ‹©ä¸‹è½½çš„å›ºä»¶ä¸Šä¼ åˆ·å…¥
5. ç­‰å¾…è·¯ç”±å™¨é‡å¯ï¼ˆ3-5åˆ†é’Ÿï¼‰
6. è®¿é—® http://192.168.6.1

## é»˜è®¤é…ç½®
- ç®¡ç†åœ°å€ï¼š192.168.6.1
- WiFi 2.4Gï¼šlocust (å¯†ç : 36925888)
- WiFi 5Gï¼šlocust-5G (å¯†ç : 36925888)
- PPPoEï¼šå·²é¢„é…ç½®è´¦å·å¯†ç 

**æ³¨æ„**ï¼šåˆ·æœºåå»ºè®®ç«‹å³ä¿®æ”¹ PPPoE å¯†ç å’Œ WiFi å¯†ç ï¼

## å†å²ç‰ˆæœ¬
å†å²ç‰ˆæœ¬æ–‡ä»¶ä¼šä¿ç•™åœ¨æ­¤ç›®å½•ä¸­ï¼Œå¯æŒ‰éœ€ä¸‹è½½æ—§ç‰ˆæœ¬ã€‚
EOF
        
        # åˆ—å‡ºæ‰€æœ‰å›ºä»¶æ–‡ä»¶
        echo "" >> firmware/README.md
        echo "## æ–‡ä»¶åˆ—è¡¨" >> firmware/README.md
        echo '```' >> firmware/README.md
        ls -la firmware/*.bin 2>/dev/null | head -20 >> firmware/README.md
        echo '```' >> firmware/README.md
        
        # æäº¤æ›´æ”¹
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        git add firmware/
        git commit -m "æ›´æ–°å›ºä»¶: $(date +%Y%m%d-%H%M%S)"
        git push origin main
        
        echo "âœ… å›ºä»¶å·²æˆåŠŸä¸Šä¼ åˆ° https://github.com/ljzz/bianyi/tree/main/firmware"

    - name: è¾“å‡ºç»“æœä¿¡æ¯
      if: success()
      run: |
        echo "ğŸ‰ ç¼–è¯‘å®Œæˆï¼"
        echo ""
        echo "å›ºä»¶ä¸‹è½½åœ°å€ï¼š"
        echo "https://github.com/ljzz/bianyi/raw/main/firmware/${{ steps.prepare-firmware.outputs.firmware_name }}"
        echo ""
        echo "æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶ï¼š"
        echo "https://github.com/ljzz/bianyi/tree/main/firmware"
        echo ""
        echo "ä¸‹æ¬¡ç¼–è¯‘ï¼š"
        echo "1. è®¿é—® https://github.com/ljzz/bianyi/actions"
        echo "2. ç‚¹å‡»ã€ç¼–è¯‘ N60 PRO å›ºä»¶ã€"
        echo "3. ç‚¹å‡»ã€Run workflowã€"
