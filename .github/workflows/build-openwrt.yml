name: ç¼–è¯‘ N60 PRO é«˜åŠŸç‡å›ºä»¶

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'æ‰§è¡Œå®Œæ•´æ¸…ç†ç¼–è¯‘ï¼ˆè€—æ—¶æ›´é•¿ï¼‰'
        required: false
        default: 'false'
        type: string

env:
  SOURCE_URL: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  CONFIG_REPO: "https://github.com/padavanonly/immortalwrt-mt798x-6.6/blob/2410/defconfig/nx60pro-ipailna-high-power.config"
  CONFIG_BRANCH: "2410"
  CONFIG_PATH: "defconfig/nx60pro-ipailna-high-power.config"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-pip rsync unzip zlib1g-dev file wget curl

    - name: å…‹éš† ImmortalWrt æºç 
      run: |
        echo "æ­£åœ¨å…‹éš†æºç ä»“åº“..."
        git clone --depth 1 --branch main $SOURCE_URL openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: è·å–é«˜åŠŸç‡é…ç½®æ–‡ä»¶
      run: |
        cd openwrt
        echo "æ­£åœ¨è·å–é«˜åŠŸç‡é…ç½®æ–‡ä»¶..."
        
        # æ–¹æ³•1: å°è¯•ç›´æ¥ä¸‹è½½ï¼ˆå¯èƒ½å› DNSé—®é¢˜å¤±è´¥ï¼‰
        if wget -q -O downloaded.config "https://raw.githubusercontent.com/${{ env.CONFIG_REPO#https://github.com/ }}/$CONFIG_BRANCH/$CONFIG_PATH"; then
          echo "âœ… é€šè¿‡ç›´æ¥ä¸‹è½½è·å–é…ç½®æ–‡ä»¶"
          mv downloaded.config .config
        else
          echo "âš ï¸ ç›´æ¥ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å…‹éš†ä»“åº“è·å–..."
          # æ–¹æ³•2: å…‹éš†æ•´ä¸ªé…ç½®ä»“åº“è·å–æ–‡ä»¶
          git clone --depth=1 --branch=$CONFIG_BRANCH $CONFIG_REPO config-repo
          if [ -f "config-repo/$CONFIG_PATH" ]; then
            cp "config-repo/$CONFIG_PATH" .config
            echo "âœ… é€šè¿‡å…‹éš†ä»“åº“è·å–é…ç½®æ–‡ä»¶"
          else
            echo "âŒ ä¸¤ç§æ–¹å¼å‡æ— æ³•è·å–é…ç½®æ–‡ä»¶"
            echo "åœ¨ config-repo ä¸­æ‰¾åˆ°çš„æ–‡ä»¶ï¼š"
            find config-repo -name "*.config" -type f | head -10
            exit 1
          fi
        fi

    - name: ä¿®å¤é…ç½®æ–‡ä»¶æ ¼å¼
      run: |
        cd openwrt
        echo "ä¿®å¤ .config æ–‡ä»¶æ ¼å¼..."
        
        # 1. å¤‡ä»½åŸå§‹æ–‡ä»¶
        cp .config .config.backup
        
        # 2. æ¸…ç†è¡Œé¦–ç©ºç™½ï¼ˆç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦ï¼‰
        sed -i 's/^[[:space:]]*//' .config
        
        # 3. ä¿®å¤å¯èƒ½çš„HTMLå®ä½“å­—ç¬¦
        sed -i 's/&nbsp;/ /g; s/&amp;/\&/g; s/&lt;/</g; s/&gt;/>/g' .config
        
        # 4. åˆ é™¤ç©ºè¡Œå’Œä»…å«ç©ºæ ¼çš„è¡Œ
        sed -i '/^[[:space:]]*$/d' .config
        
        # 5. ç¡®ä¿æ¯è¡Œéƒ½æ˜¯æœ‰æ•ˆçš„é…ç½®æ ¼å¼
        # ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ³¨é‡Šä¸­çš„ä¸­æ–‡å­—ç¬¦å¼•èµ·çš„ç¼–ç é—®é¢˜
        sed -i 's/#.*$//' .config
        sed -i '/^$/d' .config
        
        echo "æ ¼å¼ä¿®å¤å®Œæˆï¼Œå·®å¼‚å¯¹æ¯”ï¼š"
        diff -u .config.backup .config | head -20 || true

    - name: é…ç½®ç›®æ ‡è®¾å¤‡ä¸å†…æ ¸
      run: |
        cd openwrt
        echo "é…ç½®ç›®æ ‡è®¾å¤‡..."
        
        # è®¾ç½®ç›®æ ‡å¹³å°å’Œè®¾å¤‡
        echo "CONFIG_TARGET_MEDIATEK_FILOGIC=y" >> .config
        echo "CONFIG_TARGET_MEDIATEK_FILOGIC_DEVICE_CMCC_N60_PRO=y" >> .config
        
        # åº”ç”¨åŸºç¡€é…ç½®
        make defconfig
        echo "âœ… åŸºç¡€é…ç½®å®Œæˆ"

    - name: è‡ªå®šä¹‰è½¯ä»¶åŒ…é€‰æ‹©
      run: |
        cd openwrt
        echo "é…ç½®è‡ªå®šä¹‰è½¯ä»¶åŒ…..."
        
        # å¿…é¡»å®‰è£…çš„ç»„ä»¶
        cat >> .config << 'CONFIG_EOF'
CONFIG_PACKAGE_luci-theme-argon=y
CONFIG_PACKAGE_luci-app-openclash=y
CONFIG_PACKAGE_luci-app-istore=y
CONFIG_PACKAGE_luci-i18n-istore-zh-cn=y
CONFIG_EOF
        
        # OpenClash æ ¸å¿ƒä¾èµ–
        cat >> .config << 'CONFIG_EOF'
CONFIG_PACKAGE_bash=y
CONFIG_PACKAGE_coreutils=y
CONFIG_PACKAGE_coreutils-nohup=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_ip-full=y
CONFIG_PACKAGE_iptables-mod-tproxy=y
CONFIG_PACKAGE_iptables-mod-extra=y
CONFIG_PACKAGE_kmod-inet-diag=y
CONFIG_PACKAGE_kmod-nft-tproxy=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_EOF
        
        # ç§»é™¤ä¸éœ€è¦çš„åŒ…
        cat >> .config << 'CONFIG_EOF'
CONFIG_PACKAGE_luci-app-adblock=n
CONFIG_PACKAGE_luci-app-docker=n
CONFIG_PACKAGE_docker=n
CONFIG_PACKAGE_dockerd=n
CONFIG_EOF
        
        # æ›´æ–°é…ç½®
        make defconfig
        echo "âœ… è½¯ä»¶åŒ…é…ç½®å®Œæˆ"

    - name: åˆ›å»ºè‡ªå®šä¹‰é…ç½®æ–‡ä»¶
      run: |
        echo "ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶..."
        mkdir -p openwrt/files/etc/uci-defaults
        
        # ä½¿ç”¨Pythonåˆ›å»ºæ–‡ä»¶ï¼Œé¿å…YAML heredocé—®é¢˜
        python3 -c "
config_content = '''#!/bin/sh
# è‡ªå®šä¹‰åˆå§‹é…ç½®è„šæœ¬
# LAN è®¾ç½®
uci set network.lan.ipaddr='192.168.6.1'
uci set network.lan.netmask='255.255.255.0'

# PPPoE æ‹¨å·è®¾ç½®
uci delete network.wan 2>/dev/null || true
uci set network.wan=interface
uci set network.wan.proto='pppoe'
uci set network.wan.username='15828860970'
uci set network.wan.password='147258'
uci set network.wan.ipv6='auto'

# IPv6 é…ç½®
uci set dhcp.lan.dhcpv6='server'
uci set dhcp.lan.ra='server'
uci set dhcp.lan.ra_management='1'

# 2.4GHz WiFi è®¾ç½®
uci set wireless.radio0.channel='auto'
uci set wireless.radio0.htmode='HE40'
uci set wireless.default_radio0.ssid='locust'
uci set wireless.default_radio0.key='36925888'
uci set wireless.default_radio0.encryption='psk2'

# 5GHz WiFi è®¾ç½®
uci set wireless.radio1.channel='auto'
uci set wireless.radio1.htmode='HE160'
uci set wireless.default_radio1.ssid='locust-5G'
uci set wireless.default_radio1.key='36925888'
uci set wireless.default_radio1.encryption='psk2'

# æäº¤æ‰€æœ‰æ›´æ”¹
uci commit network
uci commit wireless
uci commit dhcp

exit 0
'''

with open('openwrt/files/etc/uci-defaults/99-custom', 'w') as f:
    f.write(config_content)
"
        
        chmod +x openwrt/files/etc/uci-defaults/99-custom
        echo "âœ… è‡ªå®šä¹‰é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"

    - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–
      run: |
        cd openwrt
        echo "ä¸‹è½½ä¾èµ–åŒ…..."
        make download -j$(nproc) || make download -j4 || make download -j1
        echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç†ç¼–è¯‘
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "æ‰§è¡Œå®Œæ•´æ¸…ç†ç¼–è¯‘..."
          make clean
          make dirclean
        fi
        
        # å¼€å§‹ç¼–è¯‘ï¼Œå°è¯•å¹¶è¡Œç¼–è¯‘ï¼Œå¤±è´¥æ—¶é™çº§
        make -j$(nproc) || make -j$(($(nproc)/2)) || make -j1 V=s
        
        echo "ç¼–è¯‘å®Œæˆï¼"
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if find bin/targets -name "*.bin" -type f 2>/dev/null | grep -q .; then
          echo "âœ… æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼š"
          find bin/targets -name "*n60pro*.bin" -o -name "*cmcc*.bin" -type f 2>/dev/null | head -5
        else
          echo "âš ï¸ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œæ£€æŸ¥ç›®å½•ç»“æ„ï¼š"
          find bin/targets -type f 2>/dev/null | head -10
        fi

    - name: å‡†å¤‡å›ºä»¶æ–‡ä»¶
      id: prepare
      run: |
        echo "å‡†å¤‡å›ºä»¶æ–‡ä»¶..."
        
        # åœ¨ç¼–è¯‘è¾“å‡ºç›®å½•ä¸­æŸ¥æ‰¾å›ºä»¶
        cd openwrt
        
        # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶çš„å‡ ç§å¯èƒ½åç§°
        FIRMWARE_FILE=$(find bin/targets -name "*cmcc_n60pro*sysupgrade.bin" -type f 2>/dev/null | head -1)
        
        if [ -z "$FIRMWARE_FILE" ]; then
          FIRMWARE_FILE=$(find bin/targets -name "*n60pro*.bin" -type f 2>/dev/null | head -1)
        fi
        
        if [ -z "$FIRMWARE_FILE" ]; then
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šåç§°ï¼Œæ‰¾ä»»ä½•sysupgrade.binæ–‡ä»¶
          FIRMWARE_FILE=$(find bin/targets -name "*sysupgrade.bin" -type f 2>/dev/null | head -1)
        fi
        
        if [ -z "$FIRMWARE_FILE" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "ç¼–è¯‘è¾“å‡ºç›®å½•å†…å®¹ï¼š"
          ls -la bin/targets/ 2>/dev/null || true
          exit 1
        fi
        
        echo "æ‰¾åˆ°å›ºä»¶ï¼š$FIRMWARE_FILE"
        
        # é‡å‘½åå›ºä»¶
        FIRMWARE_NAME="immortalwrt-n60pro-highpower-$(date +%Y%m%d-%H%M).bin"
        cp "$FIRMWARE_FILE" "/tmp/$FIRMWARE_NAME"
        
        # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
        cd /tmp
        md5sum "$FIRMWARE_NAME" > "$FIRMWARE_NAME.md5"
        sha256sum "$FIRMWARE_NAME" > "$FIRMWARE_NAME.sha256"
        
        # åˆ›å»ºå›ºä»¶ä¿¡æ¯æ–‡ä»¶
        cat > firmware-info.txt << 'INFO_EOF'
è®¾å¤‡å‹å·ï¼šCMCC N60 PRO
å›ºä»¶åç§°ï¼š$FIRMWARE_NAME
ç¼–è¯‘æ—¶é—´ï¼š$(date)
æºç ç‰ˆæœ¬ï¼šImmortalWrt 24.10
é…ç½®ç±»å‹ï¼šé«˜åŠŸç‡ç‰ˆæœ¬

åŒ…å«åŠŸèƒ½ï¼š
- Argon ä¸»é¢˜
- OpenClash
- iStore
- PPPoE æ‹¨å·é¢„é…ç½®
- IPv6 è‡ªåŠ¨å¯ç”¨

é»˜è®¤é…ç½®ï¼š
- ç®¡ç†åœ°å€ï¼š192.168.6.1
- WiFi 2.4Gï¼šlocust (å¯†ç : 36925888)
- WiFi 5Gï¼šlocust-5G (å¯†ç : 36925888)
- PPPoEè´¦å·ï¼š15828860970
- PPPoEå¯†ç ï¼š147258

åˆ·æœºè¯´æ˜ï¼š
1. åœ¨åŸå‚ç³»ç»Ÿé€‰æ‹©"ç³»ç»Ÿå‡çº§"
2. ä¸Šä¼ æœ¬å›ºä»¶æ–‡ä»¶
3. ç­‰å¾…é‡å¯å®Œæˆï¼ˆ3-5åˆ†é’Ÿï¼‰
4. è®¿é—® http://192.168.6.1

æ³¨æ„äº‹é¡¹ï¼š
- ä»…é€‚ç”¨äº CMCC N60 PRO è·¯ç”±å™¨
- åˆ·æœºåå»ºè®®ç«‹å³ä¿®æ”¹å¯†ç 
- é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´åˆå§‹åŒ–
INFO_EOF
        
        # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "firmware_name=$FIRMWARE_NAME" >> $GITHUB_OUTPUT
        echo "âœ… å›ºä»¶å‡†å¤‡å®Œæˆ"

    - name: ä¸Šä¼ å›ºä»¶åˆ°ä»“åº“
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ä¸Šä¼ å›ºä»¶åˆ° ljzz/bianyi ä»“åº“..."
        
        # å…‹éš†ç›®æ ‡ä»“åº“
        git clone https://x-access-token:$GITHUB_TOKEN@github.com/ljzz/bianyi.git firmware-repo
        cd firmware-repo
        
        # åˆ›å»ºæˆ–æ¸…ç©º firmware ç›®å½•
        mkdir -p firmware
        rm -rf firmware/*
        
        # å¤åˆ¶å›ºä»¶åŠç›¸å…³æ–‡ä»¶
        cp /tmp/immortalwrt-n60pro-highpower-*.bin firmware/ 2>/dev/null || true
        cp /tmp/*.md5 firmware/ 2>/dev/null || true
        cp /tmp/*.sha256 firmware/ 2>/dev/null || true
        cp /tmp/firmware-info.txt firmware/ 2>/dev/null || true
        
        # åˆ›å»ºè¯¦ç»†çš„ README
        cat > firmware/README.md << 'README_EOF'
# N60 PRO é«˜åŠŸç‡å›ºä»¶ä»“åº“

æ­¤ç›®å½•åŒ…å«ä¸º **CMCC N60 PRO** è·¯ç”±å™¨ç¼–è¯‘çš„ ImmortalWrt é«˜åŠŸç‡å›ºä»¶ã€‚

## æœ€æ–°å›ºä»¶
**æ–‡ä»¶å**: `immortalwrt-n60pro-highpower-YYYYMMDD-HHMM.bin`
**ç¼–è¯‘æ—¶é—´**: æ¯æ¬¡æ‰‹åŠ¨è§¦å‘å·¥ä½œæµæ—¶æ›´æ–°
**æºç ç‰ˆæœ¬**: ImmortalWrt 24.10
**æ— çº¿é…ç½®**: é«˜åŠŸç‡ç‰ˆæœ¬

## å†…ç½®åŠŸèƒ½
- âœ… **Argon** ç°ä»£åŒ–ä¸»é¢˜
- âœ… **OpenClash** ä»£ç†å·¥å…·
- âœ… **iStore** è½¯ä»¶ä¸­å¿ƒ
- âœ… **PPPoE** æ‹¨å·é¢„é…ç½®
- âœ… **IPv6** è‡ªåŠ¨å¯ç”¨
- âŒ AdBlock (å·²ç§»é™¤)
- âŒ Docker (å·²ç§»é™¤)

## é»˜è®¤ç½‘ç»œé…ç½®
| é¡¹ç›® | é…ç½®å€¼ |
|------|--------|
| ç®¡ç†åœ°å€ | 192.168.6.1 |
| WiFi 2.4G | SSID: `locust`, å¯†ç : `36925888` |
| WiFi 5G | SSID: `locust-5G`, å¯†ç : `36925888` |
| PPPoEè´¦å· | 15828860970 |
| PPPoEå¯†ç  | 147258 |

## åˆ·æœºæ­¥éª¤
1. **å‡†å¤‡**: ä¸‹è½½æœ€æ–°çš„ `.bin` æ–‡ä»¶åˆ°ç”µè„‘
2. **ç™»å½•**: è®¿é—®è·¯ç”±å™¨åŸå‚ç®¡ç†ç•Œé¢
3. **å‡çº§**: è¿›å…¥"ç³»ç»Ÿå‡çº§"é¡µé¢
4. **åˆ·å…¥**: é€‰æ‹©å›ºä»¶æ–‡ä»¶å¹¶ä¸Šä¼ åˆ·å…¥
5. **ç­‰å¾…**: è·¯ç”±å™¨è‡ªåŠ¨é‡å¯ï¼ˆçº¦3-5åˆ†é’Ÿï¼‰
6. **è®¿é—®**: æ‰“å¼€æµè§ˆå™¨è®¿é—® http://192.168.6.1

## å®‰å…¨æé†’
âš ï¸ **é‡è¦**: åˆ·æœºåè¯·ç«‹å³ï¼š
- ä¿®æ”¹ PPPoE å¯†ç ï¼ˆé»˜è®¤å¯†ç å·²å†…ç½®åœ¨å›ºä»¶ä¸­ï¼‰
- ä¿®æ”¹ WiFi å¯†ç 
- ä¿®æ”¹ç®¡ç†åå°å¯†ç 

## æ–‡ä»¶è¯´æ˜
- `*.bin` - ä¸»åˆ·æœºå›ºä»¶æ–‡ä»¶
- `*.md5` - MD5 æ ¡éªŒæ–‡ä»¶
- `*.sha256` - SHA256 æ ¡éªŒæ–‡ä»¶
- `firmware-info.txt` - è¯¦ç»†å›ºä»¶ä¿¡æ¯

## ç¼–è¯‘ä¿¡æ¯
æ­¤å›ºä»¶ç”± GitHub Actions è‡ªåŠ¨ç¼–è¯‘ï¼Œæºç åŸºäº [padavanonly/immortalwrt-mt798x](https://github.com/padavanonly/immortalwrt-mt798x) ä»“åº“ã€‚

---
**æ³¨æ„**: ä»…é€‚ç”¨äº **CMCC N60 PRO** å‹å·è·¯ç”±å™¨ï¼Œåˆ·æœºæœ‰é£é™©ï¼Œè¯·ç¡®ä¿å‹å·åŒ¹é…ï¼
README_EOF
        
        # åˆ—å‡ºå½“å‰ç›®å½•ä¸‹çš„å›ºä»¶æ–‡ä»¶
        echo "" >> firmware/README.md
        echo "## å½“å‰æ–‡ä»¶åˆ—è¡¨" >> firmware/README.md
        echo "\`\`\`" >> firmware/README.md
        ls -lh firmware/*.bin 2>/dev/null | head -10 >> firmware/README.md || echo "æš‚æ— å›ºä»¶æ–‡ä»¶" >> firmware/README.md
        echo "\`\`\`" >> firmware/README.md
        
        # æäº¤æ›´æ”¹
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        git add firmware/
        git commit -m "ğŸ“¦ æ›´æ–°å›ºä»¶: $(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')"
        
        # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥å¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰æ›´æ”¹
        git push origin main || echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æ¨é€"
        
        echo "âœ… å›ºä»¶å·²ä¸Šä¼ åˆ°: https://github.com/ljzz/bianyi/tree/main/firmware"
        echo "ğŸ“¥ ç›´æ¥ä¸‹è½½é“¾æ¥: https://github.com/ljzz/bianyi/raw/main/firmware/${{ steps.prepare.outputs.firmware_name }}"

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      if: always()
      run: |
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf /tmp/immortalwrt-* 2>/dev/null || true
        echo "âœ… æ¸…ç†å®Œæˆ"
