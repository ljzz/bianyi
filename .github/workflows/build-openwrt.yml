name: Compile N60 PRO Firmware

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Clean build (recommended false)'
        required: false
        default: false
        type: boolean

env:
  REPO_URL: "https://github.com/ljzz/bianyi.git"
  SOURCE_URL: "https://github.com/padavanonly/immortalwrt-mt798x-24.10"
  HIGH_POWER_CONFIG: "https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-highpower.config"

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
    - name: Check source repository
      uses: actions/checkout@v4

    - name: Prepare build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget curl

    - name: Clone ImmortalWrt source
      run: |
        echo "Cloning ImmortalWrt source..."
        git clone --depth 1 --branch main $SOURCE_URL openwrt-build
        cd openwrt-build
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply high power config
      run: |
        cd openwrt-build
        echo "Downloading high power config..."
        wget -q -O .config "$HIGH_POWER_CONFIG"
        
        # Ensure correct device is selected
        echo "CONFIG_TARGET_MEDIATEK_FILOGIC=y" >> .config
        echo "CONFIG_TARGET_MEDIATEK_FILOGIC_DEVICE_CMCC_N60_PRO=y" >> .config
        
        echo "Applying base config..."
        make defconfig

    - name: Configure packages
      run: |
        cd openwrt-build
        echo "Configuring packages..."
        
        # Add required packages
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-istore=y" >> .config
        
        # OpenClash dependencies
        echo "CONFIG_PACKAGE_bash=y" >> .config
        echo "CONFIG_PACKAGE_coreutils-nohup=y" >> .config
        echo "CONFIG_PACKAGE_curl=y" >> .config
        
        # Remove unwanted packages
        echo "CONFIG_PACKAGE_luci-app-adblock=n" >> .config
        echo "CONFIG_PACKAGE_luci-app-docker=n" >> .config
        
        # Update config
        make defconfig

    - name: Create default config files
      run: |
        echo "Creating default config files..."
        mkdir -p openwrt-build/files/etc/uci-defaults
        
        cat > openwrt-build/files/etc/uci-defaults/99-custom << 'EOF'
#!/bin/sh

# LAN settings
uci set network.lan.ipaddr='192.168.6.1'
uci set network.lan.netmask='255.255.255.0'

# PPPoE settings
uci delete network.wan 2>/dev/null || true
uci set network.wan=interface
uci set network.wan.proto='pppoe'
uci set network.wan.username='15828860970'
uci set network.wan.password='147258'
uci set network.wan.ipv6='auto'

# IPv6 settings
uci set dhcp.lan.dhcpv6='server'
uci set dhcp.lan.ra='server'

# WiFi 2.4G
uci set wireless.default_radio0.ssid='locust'
uci set wireless.default_radio0.key='36925888'
uci set wireless.default_radio0.encryption='psk2'

# WiFi 5G
uci set wireless.default_radio1.ssid='locust-5G'
uci set wireless.default_radio1.key='36925888'
uci set wireless.default_radio1.encryption='psk2'

uci commit
exit 0
EOF
        
        chmod +x openwrt-build/files/etc/uci-defaults/99-custom

    - name: Download dependencies
      run: |
        cd openwrt-build
        echo "Downloading dependencies..."
        make download -j$(nproc) || make download -j1

    - name: Compile firmware
      run: |
        cd openwrt-build
        
        # Check if clean build is requested
        CLEAN_BUILD="${{ github.event.inputs.clean_build }}"
        if [ "$CLEAN_BUILD" = "true" ]; then
          echo "Performing clean build..."
          make clean
        fi
        
        echo "Starting compilation..."
        # Try parallel compilation, fallback to single thread if needed
        make -j$(nproc) || make -j1 V=s
        
        echo "Compilation complete! Looking for firmware..."

    - name: Prepare firmware files
      id: prepare-firmware
      run: |
        echo "Preparing firmware files..."
        
        # Find firmware file
        cd openwrt-build
        
        # Try multiple paths
        FIRMWARE_PATH=$(find bin/targets/mediatek/filogic -name "*cmcc_n60pro*sysupgrade.bin" -type f 2>/dev/null | head -1)
        
        if [ -z "$FIRMWARE_PATH" ]; then
          echo "Trying other paths..."
          FIRMWARE_PATH=$(find . -name "*n60pro*.bin" -type f | head -1)
        fi
        
        if [ -z "$FIRMWARE_PATH" ]; then
          echo "ERROR: No firmware file found!"
          echo "Current directory structure:"
          find bin/targets/ -name "*.bin" -type f 2>/dev/null | head -20
          exit 1
        fi
        
        echo "Found firmware: $FIRMWARE_PATH"
        
        # Rename firmware
        FIRMWARE_NAME="immortalwrt-n60pro-highpower-$(date +%Y%m%d-%H%M).bin"
        cp "$FIRMWARE_PATH" "/tmp/$FIRMWARE_NAME"
        
        # Generate checksums
        cd /tmp
        md5sum "$FIRMWARE_NAME" > "$FIRMWARE_NAME.md5"
        sha256sum "$FIRMWARE_NAME" > "$FIRMWARE_NAME.sha256"
        
        # Create firmware info file
        cat > firmware-info.txt << 'EOF'
Device: CMCC N60 PRO
Compile time: $(date)
Source: ImmortalWrt 24.10
Config: High power version

Features:
- Argon theme
- OpenClash
- iStore
- PPPoE pre-configured
- IPv6 auto-enabled

Default config:
- Admin address: 192.168.6.1
- WiFi 2.4G: locust
- WiFi 5G: locust-5G
- WiFi password: 36925888
- PPPoE username: 15828860970
- PPPoE password: 147258

Flash instructions:
1. Go to system upgrade in original firmware
2. Upload this firmware file
3. Wait for reboot (3-5 minutes)
4. Access http://192.168.6.1

Note: Only for CMCC N60 PRO router
EOF
        
        echo "Firmware size: $(du -h /tmp/$FIRMWARE_NAME | cut -f1)"
        echo "Firmware MD5: $(md5sum /tmp/$FIRMWARE_NAME | cut -d' ' -f1)"
        
        # Set output variable
        echo "firmware_name=$FIRMWARE_NAME" >> $GITHUB_OUTPUT

    - name: Upload firmware to repository
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Uploading firmware to ljzz/bianyi repository..."
        
        # Clone target repository
        git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/ljzz/bianyi.git firmware-repo
        cd firmware-repo
        
        # Create or clean firmware directory
        mkdir -p firmware
        rm -rf firmware/*
        
        # Copy firmware files
        cp /tmp/immortalwrt-n60pro-highpower-*.bin firmware/
        cp /tmp/*.md5 firmware/ 2>/dev/null || true
        cp /tmp/*.sha256 firmware/ 2>/dev/null || true
        cp /tmp/firmware-info.txt firmware/
        
        # Create README
        cat > firmware/README.md << 'EOF'
# N60 PRO Firmware Repository

This contains high power ImmortalWrt firmware for CMCC N60 PRO router.

## Latest Firmware
- **File**: `immortalwrt-n60pro-highpower-YYYYMMDD-HHMM.bin`
- **Compile time**: Updated on each manual trigger
- **Included**: Argon theme, OpenClash, iStore
- **Pre-configured**: PPPoE, WiFi, admin address

## File Description
- `*.bin` - Firmware flash file
- `*.md5` - MD5 checksum file
- `*.sha256` - SHA256 checksum file
- `firmware-info.txt` - Detailed firmware info

## Flash Instructions
1. Download the latest `.bin` file
2. Login to router original admin interface
3. Go to "System Upgrade" page
4. Select and upload the firmware file
5. Wait for router reboot (3-5 minutes)
6. Access http://192.168.6.1

## Default Configuration
- Admin address: 192.168.6.1
- WiFi 2.4G: locust (password: 36925888)
- WiFi 5G: locust-5G (password: 36925888)
- PPPoE: Pre-configured account/password

**Note**: Change PPPoE password and WiFi password after flashing!

## Previous Versions
Previous versions are kept in this directory for reference.
EOF
        
        # List all firmware files
        echo "" >> firmware/README.md
        echo "## File List" >> firmware/README.md
        echo '```' >> firmware/README.md
        ls -la firmware/*.bin 2>/dev/null | head -20 >> firmware/README.md
        echo '```' >> firmware/README.md
        
        # Commit changes
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        git add firmware/
        git commit -m "Update firmware: $(date +%Y%m%d-%H%M%S)"
        git push origin main
        
        echo "âœ… Firmware uploaded to https://github.com/ljzz/bianyi/tree/main/firmware"

    - name: Output result info
      if: success()
      run: |
        echo "ðŸŽ‰ Compilation complete!"
        echo ""
        echo "Firmware download URL:"
        echo "https://github.com/ljzz/bianyi/raw/main/firmware/immortalwrt-n60pro-highpower-$(date +%Y%m%d-%H%M).bin"
        echo ""
        echo "View all files:"
        echo "https://github.com/ljzz/bianyi/tree/main/firmware"
        echo ""
        echo "Next compilation:"
        echo "1. Visit https://github.com/ljzz/bianyi/actions"
        echo "2. Click 'Compile N60 PRO Firmware'"
        echo "3. Click 'Run workflow'"
