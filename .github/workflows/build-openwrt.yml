name: build-openwrt.yml

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '选择要编译的分支'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - openwrt-24.10

env:
  # 使用237源码
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  # 高功率配置文件
  HIGH_POWER_CONFIG: https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/2410/defconfig/nx60pro-ipailna-high-power.config
  
  # 固件设置
  FIRMWARE_TAG: 237-high-power
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: 检出仓库
      uses: actions/checkout@v4
      
    - name: 设置编译环境
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # 清理系统缓存
        sudo rm -rf /etc/apt/sources.list.d/* \
          /usr/share/dotnet \
          /usr/local/lib/android \
          /opt/ghc \
          /opt/hostedtoolcache/CodeQL
        
        # 安装编译依赖
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install \
          build-essential \
          ccache \
          clang \
          cmake \
          curl \
          gawk \
          gettext \
          git \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          unzip \
          wget \
          zlib1g-dev \
          file \
          time \
          gperf \
          p7zip-full \
          libelf-dev \
          libxml-parser-perl \
          gcc-multilib \
          flex \
          bison
        
        sudo timedatectl set-timezone "$TZ"
        echo "编译环境设置完成"
    
    - name: 克隆 OpenWrt 源码
      run: |
        echo "选择的分支: ${{ github.event.inputs.branch }}"
        git clone --depth 1 -b ${{ github.event.inputs.branch }} ${{ env.REPO_URL }} openwrt
        cd openwrt
        echo "源码克隆完成"
    
    - name: 下载高功率配置
      run: |
        cd openwrt
        curl -L -o .config ${{ env.HIGH_POWER_CONFIG }}
        echo "高功率配置文件下载完成"
    
    - name: 设置软件源
      working-directory: openwrt
      run: |
        # 创建 feeds.conf.default
        cat > feeds.conf.default << 'EOF'
        src-git-full packages https://git.openwrt.org/feed/packages.git;openwrt-24.10
        src-git-full luci https://git.openwrt.org/project/luci.git;openwrt-24.10
        src-git-full routing https://git.openwrt.org/feed/routing.git;openwrt-24.10
        src-git-full telephony https://git.openwrt.org/feed/telephony.git;openwrt-24.10
        src-git istore https://github.com/linkease/istore;main
        src-git openclash https://github.com/vernesong/OpenClash.git;master
        src-git argon https://github.com/jerrykuku/luci-theme-argon.git;master
        EOF
        
        # 更新并安装 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "软件源设置完成"
    
    - name: 配置编译选项
      working-directory: openwrt
      run: |
        # 更新配置
        make defconfig
        
        # 启用 Argon 主题
        echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-argon-config=y" >> .config
        
        # 启用 OpenClash
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        
        # 启用 iStore
        echo "CONFIG_PACKAGE_luci-app-store=y" >> .config
        
        # 禁用不需要的软件包
        echo "# CONFIG_PACKAGE_luci-app-adblock is not set" >> .config
        echo "# CONFIG_PACKAGE_adblock is not set" >> .config
        echo "# CONFIG_PACKAGE_luci-app-docker is not set" >> .config
        echo "# CONFIG_PACKAGE_docker is not set" >> .config
        echo "# CONFIG_PACKAGE_dockerd is not set" >> .config
        
        # 启用 IPv6
        echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
        echo "CONFIG_PACKAGE_odhcp6c=y" >> .config
        echo "CONFIG_PACKAGE_odhcpd-ipv6only=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq_full_ipv6=y" >> .config
        
        # 生成最终配置
        make defconfig
        echo "编译选项配置完成"
    
    - name: 创建自定义配置文件
      working-directory: openwrt
      run: |
        # 创建 files 目录
        mkdir -p files/etc/config
        mkdir -p files/etc/uci-defaults
        
        # 1. 创建网络配置文件 (包含PPPoE设置)
        cat > files/etc/config/network << 'EOF'
config interface 'loopback'
    option device 'lo'
    option proto 'static'
    option ipaddr '127.0.0.1'
    option netmask '255.0.0.0'

config globals 'globals'
    option ula_prefix 'fdf8:8fc8:8e8c::/48'

config device
    option name 'br-lan'
    option type 'bridge'
    list ports 'eth0'

config interface 'lan'
    option device 'br-lan'
    option proto 'static'
    option ipaddr '192.168.6.1'
    option netmask '255.255.255.0'
    option ip6assign '60'
    option delegate '0'

config interface 'wan'
    option device 'eth1'
    option proto 'pppoe'
    option username '15828860970'
    option password '147258'
    option ipv6 'auto'
    option peerdns '0'
    list dns '223.5.5.5'
    list dns '223.6.6.6'
    option mtu '1492'

config interface 'wan6'
    option device '@wan'
    option proto 'dhcpv6'
    option reqaddress 'try'
    option reqprefix 'auto'
EOF
        
        # 2. 创建无线配置文件
        cat > files/etc/config/wireless << 'EOF'
config wifi-device 'radio0'
    option type 'mac80211'
    option channel 'auto'
    option hwmode '11a'
    option path 'pci0000:00/0000:00:00.0'
    option htmode 'HE160'
    option band '5g'
    option disabled '0'

config wifi-iface 'default_radio0'
    option device 'radio0'
    option network 'lan'
    option mode 'ap'
    option ssid 'locust-5G'
    option encryption 'psk2'
    option key '36925888'
    option isolate '0'
    option wpa_disable_eapol_key_retries '1'

config wifi-device 'radio1'
    option type 'mac80211'
    option channel 'auto'
    option hwmode '11g'
    option path 'platform/18000000.wmac'
    option htmode 'HT40'
    option band '2g'
    option disabled '0'

config wifi-iface 'default_radio1'
    option device 'radio1'
    option network 'lan'
    option mode 'ap'
    option ssid 'locust'
    option encryption 'psk2'
    option key '36925888'
    option isolate '0'
    option wpa_disable_eapol_key_retries '1'
EOF
        
        # 3. 创建系统配置文件
        cat > files/etc/config/system << 'EOF'
config system
    option hostname 'locust-router'
    option timezone 'CST-8'
    option zonename 'Asia/Shanghai'

config timeserver 'ntp'
    option enabled '1'
    list server 'ntp.aliyun.com'
    list server 'time1.cloud.tencent.com'
    list server 'cn.ntp.org.cn'

config led 'led_usb3'
    option name 'USB3'
    option sysfs 'mt7981:green:usb3'
    option trigger 'usbdev'
    option dev '1-1'
    option interval '50'

config led 'led_wan'
    option name 'WAN'
    option sysfs 'mt7981:green:wan'
    option trigger 'netdev'
    option dev 'wan'
    option mode 'link tx rx'
EOF
        
        # 4. 创建 DHCP 配置文件
        cat > files/etc/config/dhcp << 'EOF'
config dnsmasq
    option domainneeded '1'
    option boguspriv '1'
    option filterwin2k '0'
    option localise_queries '1'
    option rebind_protection '1'
    option rebind_localhost '1'
    option local '/lan/'
    option domain 'lan'
    option expandhosts '1'
    option nonegcache '0'
    option authoritative '1'
    option readethers '1'
    option leasefile '/tmp/dhcp.leases'
    option resolvfile '/tmp/resolv.conf.d/resolv.conf.auto'
    option localservice '1'
    option ednspacket_max '1232'
    option dhcpv4 'server'
    option dhcpv6 'server'
    option ra 'server'
    option ra_management '1'

config dhcp 'lan'
    option interface 'lan'
    option start '100'
    option limit '150'
    option leasetime '12h'
    option dhcpv6 'server'
    option ra 'server'
    option ra_management '1'
    list ra_flags 'managed-config'
    list ra_flags 'other-config'

config dhcp 'wan'
    option interface 'wan'
    option ignore '1'

config odhcpd 'odhcpd'
    option maindhcp '0'
    option leasefile '/tmp/hosts/odhcpd'
    option leasetrigger '/usr/sbin/odhcpd-update'
    option loglevel '4'
EOF
        
        # 5. 创建启动脚本以应用配置
        cat > files/etc/uci-defaults/99-custom-config << 'EOF'
#!/bin/sh

# 设置主题为argon
uci set luci.main.mediaurlbase='/luci-static/argon'
uci commit luci

# 启用IPv6
uci set network.wan.ipv6='auto'
uci set network.wan6.proto='dhcpv6'
uci set network.wan6.reqaddress='try'
uci set network.wan6.reqprefix='auto'
uci commit network

# 设置防火墙规则允许IPv6
uci set firewall.@defaults[0].drop_invalid='0'
uci commit firewall

# 重启服务
/etc/init.d/network restart
/etc/init.d/firewall restart

# 删除自身，只运行一次
rm -f /etc/uci-defaults/99-custom-config

exit 0
EOF
        
        chmod +x files/etc/uci-defaults/99-custom-config
        
        echo "自定义配置文件创建完成"
    
    - name: 下载软件包
      working-directory: openwrt
      run: |
        echo "开始下载软件包..."
        make download -j$(nproc)
        
        # 清理无效的小文件
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        
        echo "软件包下载完成"
    
    - name: 开始编译固件
      working-directory: openwrt
      timeout-minutes: 180
      run: |
        echo "开始编译固件，使用 $(nproc) 个线程..."
        
        # 编译固件
        make -j$(nproc) || make -j1 || make -j1 V=s
        
        # 检查编译结果
        if find bin/targets -name "*.bin" -o -name "*.img" | grep -q .; then
          echo "status=success" >> $GITHUB_OUTPUT
          
          - name: 诊断文件结构
  if: success()
  working-directory: openwrt
  run: |
    echo "完整的目录结构:"
    find bin/targets -type f -name "*.bin" -o -name "*.img" -o -name "*.gz" | head -20
    echo "bin目录结构:"
    find bin -type d | head -30
    
          # 获取设备名称
          DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' || echo "unknown")
          echo "DEVICE_NAME=${DEVICE_NAME}" >> $GITHUB_ENV
          
          echo "FILE_DATE=$(date +"%Y%m%d-%H%M")" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
          
          # 找到第一个固件文件来确定目录
          FIRST_FIRMWARE=$(find bin/targets -name "*.bin" -o -name "*.img" | head -1)
          if [ -n "$FIRST_FIRMWARE" ]; then
            FIRMWARE_DIR=$(dirname "$FIRST_FIRMWARE")
            echo "FIRMWARE_DIR=${FIRMWARE_DIR}" >> $GITHUB_ENV
            echo "找到固件目录: ${FIRMWARE_DIR}"
          else
            echo "未找到固件文件"
            exit 1
          fi
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "编译失败，请检查日志"
          exit 1
        fi
    
    - name: 整理固件文件
      if: success()
      working-directory: openwrt
      run: |
        echo "整理固件文件..."
        
        # 进入固件目录
        cd ${{ env.FIRMWARE_DIR }}
        
        # 显示当前目录和文件
        echo "当前目录: $(pwd)"
        echo "目录内容:"
        ls -la
        
        # 删除不必要的文件
        rm -rf packages
        rm -rf *.buildinfo *.manifest
        
        # 创建固件说明文件
        cat > README.md << EOF
# OpenWrt 固件说明

## 固件信息
- 编译时间: ${{ env.BUILD_DATE }}
- 源码版本: immortalwrt-mt798x-24.10
- 编译分支: ${{ github.event.inputs.branch }}
- 设备型号: ${{ env.DEVICE_NAME }}
- 配置类型: 高功率版本

## 包含功能
1. **主题**: Argon 现代化主题
2. **插件**: 
   - OpenClash (科学上网工具)
   - iStore (应用商店)
3. **网络配置**:
   - PPPoE拨号已配置
   - IPv6自动获取已启用
   - 管理地址: 192.168.6.1
4. **无线网络**:
   - 2.4G WiFi: locust (密码: 36925888)
   - 5G WiFi: locust-5G (密码: 36925888)

## 路由器配置
- 管理地址: 192.168.6.1
- 用户名: root (默认无密码)
- PPPoE账号: 15828860970
- PPPoE密码: 147258

## 注意事项
1. 首次登录请修改默认密码
2. 建议修改PPPoE密码确保安全
3. 如需重置配置，可执行 \`firstboot\` 命令

## 文件列表
EOF
        
        # 添加文件列表
        echo '```' >> README.md
        find . -maxdepth 1 -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) | sort >> README.md
        echo '```' >> README.md
        
        echo "固件整理完成"
    
    - name: 创建版本发布到你的GitHub仓库
      if: success()
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: firmware-${{ env.FILE_DATE }}-${{ env.DEVICE_NAME }}-${{ github.event.inputs.branch }}
        name: OpenWrt固件 ${{ env.DEVICE_NAME }} ${{ env.FILE_DATE }} (${{ github.event.inputs.branch }})
        body: |
          # OpenWrt 237 高功率固件
          
          **编译信息**
          - 编译时间: ${{ env.BUILD_DATE }}
          - 设备型号: ${{ env.DEVICE_NAME }}
          - 编译分支: ${{ github.event.inputs.branch }}
          - 源码: ${{ env.REPO_URL }}
          
          **固件特性**
          - 高功率无线配置
          - Argon 主题
          - 包含 OpenClash 插件
          - 包含 iStore 应用商店
          - 已配置 PPPoE 拨号
          - WiFi: locust (2.4G) / locust-5G (5G)
          - IPv6 支持
          
          **路由器配置**
          - 管理地址: 192.168.6.1
          - WiFi密码: 36925888
          - PPPoE账号: 已配置
          
          **使用说明**
          1. 选择对应的固件文件刷入
          2. 首次启动后检查网络连接
          3. 如需修改配置，请访问 192.168.6.1
          
          **注意事项**
          - 请勿泄露 PPPoE 账号密码
          - 建议首次使用后修改密码
          - 此固件仅适用于特定硬件
          
          **文件列表**:
          ```
          $(find ${{ env.FIRMWARE_DIR }} -maxdepth 1 -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) | xargs -I {} basename {} | sort)
          ```
        draft: false
        prerelease: false
        files: |
          ${{ env.FIRMWARE_DIR }}/*.bin
          ${{ env.FIRMWARE_DIR }}/*.img
          ${{ env.FIRMWARE_DIR }}/*.gz
          ${{ env.FIRMWARE_DIR }}/README.md
    
    - name: 清理旧的发布版本
      if: success()
      uses: dev-drprasad/delete-older-releases@v0.2.0
      with:
        keep_latest: 5
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
